
insert into postes
(meteor, delta_timezone, data_source, type, owner, email, phone, quartier, city, country, altitude, lat, long, load_type) values
('BAG280',   4, 0, 'station VP2', 'Micolas Cuvillier', 'micka@meteor-oi.re', '0612345678', 'Bain Boeuf', 'Bain boeuf', 'Maurice',  0,  -20.933387, 55.582768, 1),
('BBF015',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, 0, 0, 1),
('BDN240',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, 0, 0, 1),
('BER590',   4, 0, 'station VP2', 'Sabine/Pierre', 'micka@meteor-oi.re', '0612345678', 'Bérive 590', 'Le Tampon', 'la réunion',  590, -21.309871, 55.537723, 1),
('BER605',   4, 0, 'station VP2', 'Véronique', 'micka@meteor-oi.re', '0612345678', 'Bérive 605', 'Le Tampon', 'la réunion',  605, -21.30833, 55.53887, 1),
('BOCO1370', 4, 0, 'station VP2', 'Donny', 'micka@meteor-oi.re', '0612345678', 'Bois court', 'Le Tampon', 'la réunion',  1370,  -21.196061, 55.53827, 1),
('BOMU1610', 4, 0, 'station VP2', 'Patrice', 'micka@meteor-oi.re', '0612345678', 'Bourg Murat', 'Le Tampon', 'la réunion',  1600, -21.192665, 55.576251, 1),
('BP130',    4, 0, 'station VP2', 'Alexandre Nativel', 'micka@meteor-oi.re', '0612345678', 'Bassin Plat', 'Saint Pierre', 'la réunion',  135, -21.330492, 55.489393, 1),
('BPN100',   4, 0, 'station VP2', 'Ami de Jack Quillet', 'micka@meteor-oi.re', '0612345678', 'La caroline', 'Bras Panon', 'la réunion',  100, -21.002163, 55.652502, 1),
('BRL030',   4, 0, 'station VP2', 'Geoffroy', 'micka@meteor-oi.re', '0612345678', 'Baril', 'Saint Philippe', 'la réunion',  80, -21.362132, 55.725414, 1),
('BRT155',   4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'La Bretagne', 'Saint Denis', 'la réunion',  155, -20.912244, 55.493962, 1),
('BRT240',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  0, 0, 1),
('CAM015',   4, 0, 'station VP2', 'Entreprise Drone', 'micka@meteor-oi.re', '0612345678', 'Cambaie', 'Saint Paul', 'la réunion',  20, -20.961875, 55.282956, 1),
('CBG270',   4, 0, 'station VP2', 'Tony', 'micka@meteor-oi.re', '0612345678', 'Cambourg', 'Saint Benoit', 'la réunion',  260, -21.113488, 55.728536, 1),
('CHAR645',  4, 0, 'station VP2', 'Frederik/Caroline', 'micka@meteor-oi.re', '0612345678', 'Charrié', 'Petite Ile', 'la réunion',  645, -21.192665, 55.576251, 1),
('CHP690',   4, 0, 'station Vue', 'Thiébaut', 'micka@meteor-oi.re', '0612345678', 'La Chapelle/†evelave', 'Les Avirons', 'la réunion', 6900, -21.220226, 55.344443, 1),
('CRT630',   4, 0, 'station Vue', 'Micka', 'micka@meteor-oi.re', '0612345678', 'La Crete 1', 'Saint Joseph', 'la réunion',  630,  -21.335742, 55.656652, 1),
('CRT635',   4, 0, 'station Vue', 'Micka', 'micka@meteor-oi.re', '0612345678', 'La Crete 2', 'Saint Joseph', 'la réunion',  635,  -21.340014, 55.667172, 1),
('CUP575',   4, 0, 'station Vue', 'Vishal', 'micka@meteor-oi.re', '0612345678', 'Curepipe', 'Curepipe', 'Maurice',  575,   -20.933387, 55.582768, 1),
('ELH675',   4, 0, 'station Vue', 'Mat/Actus Meteo 974', 'micka@meteor-oi.re', '0612345678', 'Esperance les hauts', 'Saint Marie', 'la réunion',  670,  -20.950965, 55.516872, 1),
('ESB005',   4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Etang Salé les Bains', 'Etang Salé', 'la réunion',  10, -21.26778775, 55.335363, 1),
('ESH555',   4, 0, 'station VP2', 'Laurent', 'micka@meteor-oi.re', '0612345678', 'Etang Salé', 'Etang Salé', 'la réunion',  555, -21.236787, 55.378695, 1),
('FAY040',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -20.941706, 55.65897, 1),
('GDC030',   4, 0, 'station VP2', 'Sébastien Langlade', 'micka@meteor-oi.re', '0612345678', 'Grand Canal', 'Saint André', 'la réunion',  27, -20.95888, 55.689574, 1),
('GFD010',   4, 0, 'station VP2', 'Thierry François', 'micka@meteor-oi.re', '0612345678', 'Grand Fond', 'Saint Paul', 'la réunion',  10, -21.26778775, 55.219428, 1),
('LAN030',   4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Langevin', 'Saint Joseph', 'la réunion',  40,  -21.384245, 55.647383, 1),
('LCV050',   4, 0, 'station VP2', 'Philippe', 'micka@meteor-oi.re', '0612345678', 'La Convenance', 'Sainte Marie', 'la réunion',  45,  -20.895952, 55.572072, 1),
('MAK805',   4, 0, 'station VP2', 'Jimmy', 'micka@meteor-oi.re', '0612345678', 'Les Makes', 'Saint Louis', 'la réunion',  800, -21.217226, 55.405008, 1),
('MAT315',   4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Matouta', 'Saint Joseph', 'la réunion',  315, -21.360229, 55.70152, 1),
('MDM1570',  4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Marla', 'Saint Paul', 'la réunion',  1570, -21.100918, 55.430022, 1),
('MTG280',   4, 0, 'station VP2', 'Fréderic Caillé', 'micka@meteor-oi.re', '0612345678', 'La Montagne', 'Saint Denis', 'la réunion',  260, -20.878348, 55.428241, 1),
('MTG320',   4, 0, 'station VP2', 'Hubert', 'micka@meteor-oi.re', '0612345678', 'La Montagne', 'Saint Denis', 'la réunion',  320, -20.882, 55.424667, 1),
('MVP860',   4, 0, 'station VP2', 'Jack Quillet', 'micka@meteor-oi.re', '0612345678', 'Mare à Vieille Place', 'Salazie', 'la réunion',  860, -21.025844, 55.515549, 1),
('NDLP1520', 4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Nogtre Dame de la Paix', 'Le Tampon', 'la réunion',  1520, -21.250525, 55.584708, 1),
('PAH575',   4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Piton Armand les Hauts', 'Saint Benoit', 'la réunion',  575,  -21.122265, 55.703658, 1),
('PFD040',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  -21.300325, 55.418679, 1),
('PSL310',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  -21.300325, 55.418679, 1),
('RAM450',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  -20.928899, 55.365116, 1),
('ROQ070',   4, 0, 'station Vue', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -21.059036, 55.229183, 1),
('SPC010',   4, 0, 'station Vue', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -21.053141, 55.695668, 1),
('SBBM100',  4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -21.053141, 55.695668, 1),
('TAM1790',  4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  -21.106126, 55.362666, 1),
('TAN1270',  4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  -21.106126, 55.362666, 1),
('TAR600',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  -21.059972, 55.289673, 1),
('TBL105',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -21.317372, 55.800674, 1),
('TRG170',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -21.338827, 55.51276, 1),
('TRM490',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -21.26666, 55.495548, 1)
;
/*
  name:
  json_input: field name in json coming from weewx, and in Obs table
  archive_col: field name in weew archive database
  archive_table: table name when different than archive_col...
  field_dir: field for wind direction (not in omm measure)
  csv_field: column name in csv file
  csv_minmax: min/max in csv. Json with keys: min, minTime, max, maxTime, maxDir
  val_deca: decallage de la mesure OMM
  min: compute a min in extreme table
  min_deca: decallage du min OMM
  max: compute a max in extreme table
  max_deca: decallage du max OMM
  agreg_type: type agregation 0=None, 1=AVG, 2=SUM, 3=MAX, 4=MIN
  is_wind: is it a wind measure (need to find the winddir data)
  omm_link: for omm measure, link to the base measure
  allow_zero: not used...
  json_input_bis: ??
  is_houly: is data in json coming from weewx is a value for the full hour (etp)
*/

insert into mesures
(id,    name,            json_input,         archive_col,   archive_table, field_dir,    min,    max, agreg_type, is_wind, allow_zero, json_input_bis,   convert) values
( 1, 'barometer',       'barometer',        'barometer',         null,        null,     true,    false,    1,      false,    true,            null,        '{}'),
( 2, 'pressure',        'pressure',         'pressure',          null,        null,     false,   false,    1,      false,    true,            null,        '{}'),
(11, 'temp inside',     'in_temp',          'inTemp',            null,        null,     false,   false,    1,      false,    true,            null,        '{}'),
(12, 'temperature',     'out_temp',         'outTemp',           null,        null,     true,    true,     1,      false,    true,            null,        '{}'),
(13, 'dewpoint',        'dewpoint',         'dewpoint',          null,        null,     true,    true,     1,      false,    true,            null,        '{}'),
(14, 'etp',             'etp',              'ET',                null,        null,     false,   false,    0,      false,    true,            null,        '{}'),
(15, 'heatindex',       'heatindex',        'heatindex',         null,        null,     false,   false,    3,      false,    true,            null,        '{}'),
(16, 'extra_temp1',     'extra_temp1',      'extraTemp1',        null,        null,     false,   false,    1,      false,    true,      'extratemp1',      '{}'),
(17, 'extra_temp2',     'extra_temp2',      'extraTemp2',        null,        null,     false,   false,    1,      false,    true,      'extratemp2',      '{}'),
(18, 'extra_temp3',     'extra_temp3',      'extraTemp3',        null,        null,     false,   false,    1,      false,    true,      'extratemp3',      '{}'),
(30, 'humidity inside', 'in_humidity',      'inHumidity',        null,        null,     false,   false,    1,      false,    true,            null,        '{}'),
(31, 'humidity',        'out_humidity',     'outHumidity',       null,        null,     true,    true,     1,      false,    true,      'humidity',        '{}'),
(32, 'extrahumid1',     'extra_humid1',     'extraHumid1',       null,        null,     false,   false,    1,      false,    true,     'extrahumid1',      '{}'),
(33, 'extrahumid2',     'extra_humid2',     'extraHumid2',       null,        null,     false,   false,    1,      false,    true,     'extrahumid2',      '{}'),
(50, 'leaftemp1',       'leaf_temp1',       'leafTemp1',         null,        null,     false,   false,    1,      false,    true,     'leaftemp1',        '{}'),
(51, 'leaftemp2',       'leaf_temp2',       'leafTemp2',         null,        null,     false,   false,    1,      false,    true,     'leaftemp2',        '{}'),
(54, 'leafwet1',        'leaf_wet1',        'leafWet1',          null,        null,     false,   false,    1,      false,    true,      'leafwet1',        '{}'),
(55, 'leafwet2',        'leaf_wet2',        'leafWet2',          null,        null,     false,   false,    1,      false,    true,      'leafwet2',        '{}'),
(60, 'radiation',       'radiation',        'radiation',       'skip',        null,     false,   false,    2,      false,    true,            null,
  '{"w_dump": "lambda x: x * 0.03"}'),
(61, 'radiation_rate', 'radiation_rate',    'radiation',         null,        null,     false,   false,    3,      false,    true,            null,        '{}'),
(62, 'uv_indice',       'uv',               'UV',                null,        null,     false,   false,    3,      false,    true,            null,        '{}'),
(70, 'rain',            'rain',             'rain',            'skip',        null,     false,   false,    2,      false,    true,            null,
  '{"w_dump": "lambda x: x * 10"}'),
(71, 'rain rate',       'rain_rate',        'rainRate',          null,        null,     false,   false,    3,      false,    true,            null,        '{}'),
(80, 'rx',              'rx',               'rxCheckPercent',    null,        null,     false,   false,    4,      false,    true,            null,        '{}'),
(90, 'soilmoist1',      'soil_moist1',      'soilMoist1',        null,        null,     false,   false,    1,      false,    true,    'soilmoist1',        '{}'),
(91, 'soilmoist2',      'soil_moist2',      'soilMoist2',        null,        null,     false,   false,    1,      false,    true,    'soilmoist2',        '{}'),
(92, 'soilmoist3',      'soil_moist3',      'soilMoist3',        null,        null,     false,   false,    1,      false,    true,    'soilmoist3',        '{}'),
(93, 'soilmoist4',      'soil_moist4',      'soilMoist4',        null,        null,     false,   false,    1,      false,    true,    'soilmoist4',        '{}'),
(94, 'soiltemp1',       'soil_temp1',       'soilTemp1',         null,        null,     false,   false,    4,      false,    true,     'soiltemp1',        '{}'),
(95, 'soiltemp2',       'soil_temp2',       'soilTemp2',         null,        null,     false,   false,    4,      false,    true,     'soiltemt2',        '{}'),
(96, 'soiltemp3',       'soil_temp3',       'soilTemp3',         null,        null,     false,   false,    4,      false,    true,     'soiltemp3',        '{}'),
(97, 'soiltemp4',       'soil_temp4',       'soilTemp4',         null,        null,     false,   false,    4,      false,    true,     'soiltemp4',        '{}'),
(100, 'voltage',         'voltage',         'consBatteryVoltage',null,        null,     false,   false,    3,      false,    true,            null,        '{}'),
(110, 'wind dir',        'wind_dir',        'windDir',          'skip',       null,     false,   false,    0,      false,    true,            null,        '{}'),
(111, 'wind',            'wind',            'windSpeed',        'wind',       110,      false,   true,     1,      false,    true,            null,
  '{"mfr_csv": "lambda x: x * 3.6"}'),
(113, 'gust dir',        'wind_gust_dir',   'windGustDir',      'skip',       null,     false,   false,    0,      false,    true,  'wind_max_dir',        '{}'),
(114, 'gust',            'wind_gust',       'windGust',         'wind',       113,      false,   true,     3,       true,    true,      'wind_max',
  '{"mfr_csv": "lambda x: x * 3.6"}'),
(115, 'windchill',       'windchill',       'windchill',         null,        null,     false,   false,    4,      false,    true,            null,        '{}')
;

insert into annotations
(id,time,timeend,text,tags) values
(1,'2022-02-01 00:00:00','2022-02-05 00:00:00','Batsirai','système, cyclone intense'),
(2,'2022-02-19 00:00:00','2022-02-23 00:00:00','Emnati','système, cyclone intense'),
(3,'2018-01-16 12:00:00','2018-01-19 04:00:00','Berguitta','système,cyclone tropical intense'),
(4,'2021-01-11 00:00:00','2021-01-13 12:00:00','Danilo','forte tempête tropicale, système'),
(5,'2021-03-06 00:00:00','2021-03-08 00:00:00','Iman','système,tempête tropicale modérée'),
(6,'2019-12-29 00:00:00','2019-12-31 12:00:00','Calvinia','système, cyclone tropical'),
(7,'2018-03-03 12:00:00','2018-03-06 18:00:00','Dumazile','système, cyclone tropical intense'),
(8,'2019-11-24 00:00:00','2019-11-24 00:00:00','TAR600','première donnée'),
(9,'2011-04-13 00:00:00','2011-04-13 00:00:00','SBBM100','première donnée'),
(10,'2020-09-14 00:00:00','2020-09-14 00:00:00','CHP690','première donnée'),
(11,'2019-09-22 00:00:00','2019-09-22 00:00:00','PFD040','première donnée'),
(12,'2020-01-10 00:00:00','2020-01-10 00:00:00','NDLP1520','première donnée'),
(13,'2020-11-25 00:00:00','2020-11-25 00:00:00','BOCO1370','première donnée'),
(14,'2022-08-23 00:00:00','2022-08-23 00:00:00','BPN100','première donnée'),
(15,'2017-06-10 00:00:00','2017-06-10 00:00:00','BAG280','première donnée'),
(16,'2018-06-30 00:00:00','2018-06-30 00:00:00','ESB005','première donnée'),
(17,'2021-12-10 00:00:00','2021-12-10 00:00:00','TAM1790','première donnée'),
(18,'2013-03-24 00:00:00','2013-03-24 00:00:00','ESH555','première donnée'),
(19,'2020-08-26 00:00:00','2020-08-26 00:00:00','CHAR645','première donnée'),
(20,'2018-02-25 00:00:00','2018-02-25 00:00:00','TRM490','première donnée'),
(21,'2015-06-24 00:00:00','2015-06-24 00:00:00','BBF015','première donnée'),
(22,'2015-06-27 00:00:00','2015-06-27 00:00:00','RAM450','première donnée'),
(23,'2021-09-26 00:00:00','2021-09-26 00:00:00','LCV050','première donnée'),
(24,'2021-05-02 00:00:00','2021-05-02 00:00:00','BER590','première donnée'),
(25,'2019-11-24 00:00:00','2019-11-24 00:00:00','TAN1270','première donnée'),
(26,'2020-12-17 00:00:00','2020-12-17 00:00:00','FAY040','première donnée'),
(27,'2021-09-20 00:00:00','2021-09-20 00:00:00','MVP860','première donnée'),
(28,'2019-09-26 00:00:00','2019-09-26 00:00:00','BP130','première donnée'),
(29,'2019-02-05 00:00:00','2019-02-05 00:00:00','ELH675','première donnée'),
(30,'2019-08-09 00:00:00','2019-08-09 00:00:00','MTG320','première donnée'),
(31,'2020-08-11 00:00:00','2020-08-11 00:00:00','BOMU1610','première donnée'),
(32,'2017-03-04 00:00:00','2017-03-04 00:00:00','TBL105','première donnée'),
(33,'2017-03-09 00:00:00','2017-03-09 00:00:00','GDC030','première donnée'),
(34,'2023-12-11 00:00:00','2023-12-11 00:00:00','MTG280','première donnée'),
(35,'2022-02-10 00:00:00','2022-02-10 00:00:00','MAT315','première donnée'),
(36,'2019-09-26 00:00:00','2019-09-26 00:00:00','PSL310','première donnée'),
(37,'2017-12-11 00:00:00','2017-12-11 00:00:00','SPC010','première donnée'),
(38,'2014-12-31 00:00:00','2014-12-31 00:00:00','BRT240','première donnée'),
(39,'2016-10-20 00:00:00','2016-10-20 00:00:00','TRG170','première donnée'),
(40,'2021-04-22 00:00:00','2021-04-22 00:00:00','ROQ070','première donnée'),
(41,'2021-01-22 00:00:00','2021-01-22 00:00:00','CAM015','première donnée'),
(42,'2019-06-05 00:00:00','2019-06-05 00:00:00','LAN030','première donnée'),
(43,'2019-11-16 00:00:00','2019-11-16 00:00:00','PAH575','première donnée'),
(44,'2024-01-12 00:00:00','2024-01-17 00:00:00','Belal','système')
;
-- reset id serial to max id
SELECT SETVAL('annotations_id_seq', (SELECT MAX(id) FROM annotations));

-- display number of inserted rows
select 'nb postes: ' || count(*) from postes;
select 'nb mesures: ' || count(*) from mesures;
select 'nb annotations: ' || count(*) from annotations;

-- ---------
-- Triggers
-- ---------
-- regenerer la table last_obs
CREATE OR REPLACE PROCEDURE refesh_last_obs()
LANGUAGE SQL
AS $BODY$
  delete from last_obs;
  insert into last_obs(poste_id, mesure_id, date_local, value) select poste_id, mesure_id, max(date_local) as date_local, last(value, date_local) as value  from obs group by 1,2;
$BODY$;

/*
*  maintain last_obs_date/id in poste table
*  cascade qa_value to x_min/x_max tables
*  update last_obs table
*/ 
CREATE OR REPLACE FUNCTION create_update_obs_trigger_fn()
  RETURNS TRIGGER LANGUAGE PLPGSQL AS
$BODY$
DECLARE
    obs_dat timestamp;
    last_obs_dat timestamp;
BEGIN
  select last_obs_date  into obs_dat from postes where id = NEW.poste_id;
  if obs_dat is null or new.date_local > obs_dat then
    update postes set last_obs_date = NEW.date_local, last_obs_id = NEW.id where id = NEW.poste_id;
  end if;
  if NEW.qa_value <> OLD.qa_value then
    update x_min set qa_min = NEW.qa_value where obs_id = NEW.id;
    update x_max set qa_max = NEW.qa_value where obs_id = NEW.id;
  end if;

  -- Update last_obs
  select date_local from last_obs where poste_id = NEW.poste_id and mesure_id = NEW.mesure_id into obs_dat;

  if obs_dat is null then
    insert into last_obs (poste_id, mesure_id, date_local, value) values (NEW.poste_id, NEW.mesure_id, NEW.date_local, NEW.value);
  elsif obs_dat < NEW.date_local then
    update last_obs set date_local = NEW.date_local, value = NEW.value where poste_id = NEW.poste_id and mesure_id = NEW.mesure_id;
  end if;

  return NEW;
END
$BODY$;

CREATE OR REPLACE TRIGGER create_update_obs_trigger
  AFTER INSERT OR UPDATE ON obs
  FOR EACH ROW EXECUTE PROCEDURE create_update_obs_trigger_fn();

/*
*  cascade delete obs to x_min/x_max
*/ 
CREATE OR REPLACE FUNCTION delete_obs_trigger_fn()
  RETURNS TRIGGER LANGUAGE PLPGSQL AS
$BODY$
DECLARE
BEGIN
    delete from x_min where obs_id = OLD.id;
    delete from x_max where obs_id = OLD.id;
  return OLD;
END
$BODY$;

CREATE OR REPLACE TRIGGER delete_obs_trigger
  AFTER INSERT OR UPDATE ON x_max
  FOR EACH ROW EXECUTE PROCEDURE delete_obs_trigger_fn();
