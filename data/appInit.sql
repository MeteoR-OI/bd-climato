
insert into postes
(meteor, delta_timezone, data_source, type, owner, email, phone, quartier, city, country, altitude, lat, long, load_raw_data, load_dump) values
('BAG280',   4, 0, 'station VP2', 'Micolas Cuvillier', 'micka@meteor-oi.re', '0612345678', 'Bain Boeuf', 'Bain boeuf', 'Maurice',  0,  -20.933387, 55.582768, false, true),
('BBF015',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, 0, 0, false, true),
('BDN240',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, 0, 0, false, true),
('BER590',   4, 0, 'station VP2', 'Sabine/Pierre', 'micka@meteor-oi.re', '0612345678', 'Bérive 590', 'Le Tampon', 'la réunion',  590, -21.309871, 55.537723, false, true),
('BER605',   4, 0, 'station VP2', 'Véronique', 'micka@meteor-oi.re', '0612345678', 'Bérive 605', 'Le Tampon', 'la réunion',  605, -21.30833, 55.53887, false, true),
('BOCO1370', 4, 0, 'station VP2', 'Donny', 'micka@meteor-oi.re', '0612345678', 'Bois court', 'Le Tampon', 'la réunion',  1370,  -21.196061, 55.53827, false, true),
('BOMU1610', 4, 0, 'station VP2', 'Patrice', 'micka@meteor-oi.re', '0612345678', 'Bourg Murat', 'Le Tampon', 'la réunion',  1600, -21.192665, 55.576251, false, true),
('BP130',    4, 0, 'station VP2', 'Alexandre Nativel', 'micka@meteor-oi.re', '0612345678', 'Bassin Plat', 'Saint Pierre', 'la réunion',  135, -21.330492, 55.489393, false, true),
('BPN100',   4, 0, 'station VP2', 'Ami de Jack Quillet', 'micka@meteor-oi.re', '0612345678', 'La caroline', 'Bras Panon', 'la réunion',  100, -21.002163, 55.652502, false, true),
('BRL030',   4, 0, 'station VP2', 'Geoffroy', 'micka@meteor-oi.re', '0612345678', 'Baril', 'Saint Philippe', 'la réunion',  80, -21.362132, 55.725414, false, true),
('BRT155',   4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'La Bretagne', 'Saint Denis', 'la réunion',  155, -20.912244, 55.493962, false, true),
('BRT240',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  0, 0, false, true),
('CAM015',   4, 0, 'station VP2', 'Entreprise Drone', 'micka@meteor-oi.re', '0612345678', 'Cambaie', 'Saint Paul', 'la réunion',  20, -20.961875, 55.282956, false, true),
('CBG270',   4, 0, 'station VP2', 'Tony', 'micka@meteor-oi.re', '0612345678', 'Cambourg', 'Saint Benoit', 'la réunion',  260, -21.113488, 55.728536, false, true),
('CHAR645',  4, 0, 'station VP2', 'Frederik/Caroline', 'micka@meteor-oi.re', '0612345678', 'Charrié', 'Petite Ile', 'la réunion',  645, -21.192665, 55.576251, false, true),
('CHP690',   4, 0, 'station Vue', 'Thiébaut', 'micka@meteor-oi.re', '0612345678', 'La Chapelle/†evelave', 'Les Avirons', 'la réunion', 6900, -21.220226, 55.344443, false, true),
('CRT630',   4, 0, 'station Vue', 'Micka', 'micka@meteor-oi.re', '0612345678', 'La Crete 1', 'Saint Joseph', 'la réunion',  630,  -21.335742, 55.656652, false, true),
('CRT635',   4, 0, 'station Vue', 'Micka', 'micka@meteor-oi.re', '0612345678', 'La Crete 2', 'Saint Joseph', 'la réunion',  635,  -21.340014, 55.667172, false, true),
('CUP575',   4, 0, 'station Vue', 'Vishal', 'micka@meteor-oi.re', '0612345678', 'Curepipe', 'Curepipe', 'Maurice',  575,   -20.933387, 55.582768, false, true),
('ELH675',   4, 0, 'station Vue', 'Mat/Actus Meteo 974', 'micka@meteor-oi.re', '0612345678', 'Esperance les hauts', 'Saint Marie', 'la réunion',  670,  -20.950965, 55.516872, false, true),
('ESB005',   4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Etang Salé les Bains', 'Etang Salé', 'la réunion',  10, -21.26778775, 55.335363, false, true),
('ESH555',   4, 0, 'station VP2', 'Laurent', 'micka@meteor-oi.re', '0612345678', 'Etang Salé', 'Etang Salé', 'la réunion',  555, -21.236787, 55.378695, false, true),
('FAY040',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -20.941706, 55.65897, false, true),
('GDC030',   4, 0, 'station VP2', 'Sébastien Langlade', 'micka@meteor-oi.re', '0612345678', 'Grand Canal', 'Saint André', 'la réunion',  27, -20.95888, 55.689574, false, true),
('GFD010',   4, 0, 'station VP2', 'Thierry François', 'micka@meteor-oi.re', '0612345678', 'Grand Fond', 'Saint Paul', 'la réunion',  10, -21.26778775, 55.219428, false, true),
('LAN030',   4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Langevin', 'Saint Joseph', 'la réunion',  40,  -21.384245, 55.647383, false, true),
('LCV050',   4, 0, 'station VP2', 'Philippe', 'micka@meteor-oi.re', '0612345678', 'La Convenance', 'Sainte Marie', 'la réunion',  45,  -20.895952, 55.572072, false, true),
('MAK805',   4, 0, 'station VP2', 'Jimmy', 'micka@meteor-oi.re', '0612345678', 'Les Makes', 'Saint Louis', 'la réunion',  800, -21.217226, 55.405008, false, true),
('MAT315',   4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Matouta', 'Saint Joseph', 'la réunion',  315, -21.360229, 55.70152, false, true),
('MDM1570',  4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Marla', 'Saint Paul', 'la réunion',  1570, -21.100918, 55.430022, false, true),
('MTG280',   4, 0, 'station VP2', 'Fréderic Caillé', 'micka@meteor-oi.re', '0612345678', 'La Montagne', 'Saint Denis', 'la réunion',  260, -20.878348, 55.428241, false, true),
('MTG320',   4, 0, 'station VP2', 'Hubert', 'micka@meteor-oi.re', '0612345678', 'La Montagne', 'Saint Denis', 'la réunion',  320, -20.882, 55.424667, false, true),
('MVP860',   4, 0, 'station VP2', 'Jack Quillet', 'micka@meteor-oi.re', '0612345678', 'Mare à Vieille Place', 'Salazie', 'la réunion',  860, -21.025844, 55.515549, false, true),
('NDLP1520', 4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Nogtre Dame de la Paix', 'Le Tampon', 'la réunion',  1520, -21.250525, 55.584708, false, true),
('PAH575',   4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Piton Armand les Hauts', 'Saint Benoit', 'la réunion',  575,  -21.122265, 55.703658, false, true),
('PFD040',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  -21.300325, 55.418679, false, true),
('PSL310',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  -21.300325, 55.418679, false, true),
('RAM450',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  -20.928899, 55.365116, false, true),
('ROQ070',   4, 0, 'station Vue', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -21.059036, 55.229183, false, true),
('SPC010',   4, 0, 'station Vue', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -21.053141, 55.695668, false, true),
('SBBM100',  4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -21.053141, 55.695668, false, true),
('TAM1790',  4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  -21.106126, 55.362666, false, true),
('TAN1270',  4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  -21.106126, 55.362666, false, true),
('TAR600',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  -21.059972, 55.289673, false, true),
('TBL105',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -21.317372, 55.800674, false, true),
('TRG170',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -21.338827, 55.51276, false, true),
('TRM490',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -21.26666, 55.495548, false, true)
;
/*
  name:
  json_input: field name in json coming from weewx, and in Obs table
  archive_col: field name in weew archive database
  archive_table: table name when different than archive_col...
  field_dir: field for wind direction (not in omm measure)
  csv_field: column name in csv file
  csv_minmax: min/max in csv. Json with keys: min, minTime, max, maxTime, maxDir
  val_deca: decallage de la mesure OMM
  min: compute a min in extreme table
  min_deca: decallage du min OMM
  max: compute a max in extreme table
  max_deca: decallage du max OMM
  is_avg: if False the measure is a sum
  is_wind: is it a wind measure (need to find the winddir data)
  omm_link: for omm measure, link to the base measure
  allow_zero: not used...
  json_input_bis: ??
  is_houly: is data in json coming from weewx is a value for the full hour (etp)
*/

insert into mesures
(id,    name,            json_input,         archive_col,   archive_table, field_dir, val_deca, min, min_deca, max,  max_deca, is_avg, is_wind, omm_link, allow_zero,     json_input_bis, is_hourly) values
( 1, 'barometer',       'barometer',        'barometer',          null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
-- ( 4, 'barometer omm',   'barometer_omm',    'barometer',          null,        null,     0,   true,    0,     true,    0,      true,   false,       1,      true,            null,        False),
( 6, 'dewpoint',        'dewpoint',         'dewpoint',           null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
( 8, 'etp',             'etp',              'ET',                 null,        null,     0,   true,    0,     true,    0,      false,  false,    null,      true,            null,         True),
(10, 'extra_temp1',     'extra_temp1',      'extraTemp1',         null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(12, 'extra_temp2',     'extra_temp2',      'extraTemp2',         null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(14, 'extra_temp3',     'extra_temp3',      'extraTemp3',         null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(16, 'extrahumid1',     'extra_humid1',     'extraHumid1',        null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(18, 'extrahumid2',     'extra_humid2',     'extraHumid2',        null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(20, 'gust',            'wind_gust',        'windGust',           'wind',        22,     0,   false,   0,     true,    0,      true,   true,     null,      true,      'wind_max',        False),
(22, 'gust dir',        'wind_gust_dir',    'windGustDir',        'skip',      null,     0,   false,   0,     false,   0,      true,   false,    null,      true,  'wind_max_dir',        False),
(24, 'hail rate',       'hail_rate',        'hailRate',           null,        null,     0,   false,   0,     true,    0,      true,   false,    null,      true,            null,        False),
(26, 'hail',            'hail',             'hail',               null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
(28, 'heatindex',       'heatindex',        'heatindex',          null,        null,     0,   false,   0,     true,    0,      true,   false,    null,      true,            null,        False),
(30, 'heating temp',    'heating_temp',     'heatingTemp',        null,        null,     0,   false,   0,     true,    0,      true,   false,    null,      true,            null,        False),
(32, 'humidity inside', 'in_humidity',      'inHumidity',         null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
(34, 'humidity',        'out_humidity',     'outHumidity',        null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,      'humidity',        False),
-- (36, 'humidity omm',    'out_humidity_omm', 'outHumidity',        null,        null,     0,   true,    0,     true,    0,      true,   false,      34,      true,  'humidity_omm',        False),
(38, 'leaftemp1',       'leaf_temp1',       'leafTemp1',          null,        null,     0,  false,   0,     false,   0,      true,   false,    null,      true,      'leaftemp',        False),
(40, 'leaftemp2',       'leaf_temp2',       'leafTemp2',          null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(42, 'leafwet1',        'leaf_wet1',        'leafWet1',           null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,       'leafwet',        False),
(44, 'leafwet2',        'leaf_wet2',        'leafWet2',           null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(46, 'pressure',        'pressure',         'pressure',           null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
(48, 'radiation',       'radiation',        'radiation',          null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
(50, 'rain rate',       'rain_rate',        'rainRate',           null,        null,     0,   false,   0,     true,    0,      true,   false,    null,      true,            null,        False),
(52, 'rain',            'rain',             'rain',               null,        null,     0,   false,   0,     true,    0,      false,  false,    null,      true,            null,        False),
-- (54, 'rain omm',        'rain_omm',         'rain',               null,        null,    -7,   false,   0,     true,    7,      false,  false,      52,      true,            null,        False),
(56, 'rx',              'rx',               'rxCheckPercent',     null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
(58, 'soilmoist1',      'soil_moist1',      'soilMoist1',         null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,     'soilmoist',        False),
(60, 'soilmoist2',      'soil_moist2',      'soilMoist2',         null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(62, 'soilmoist3',      'soil_moist3',      'soilMoist3',         null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(64, 'soilmoist4',      'soil_moist4',      'soilMoist4',         null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(66, 'soiltemp1',       'soil_temp1',       'soilTemp1',          null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,      'soiltemp',        False),
(68, 'soiltemp2',       'soil_temp2',       'soilTemp2',          null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(70, 'soiltemp3',       'soil_temp3',       'soilTemp3',          null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(72, 'soiltemp4',       'soil_temp4',       'soilTemp4',          null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(74, 'temp inside',     'in_temp',          'inTemp',             null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
(76, 'temperature',     'out_temp',         'outTemp',            null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
-- (78, 'temp omm',        'out_temp_omm',     'outTemp',            null,        null,     0,   true,    5,     true,   -7,      true,   false,      76,      true,            null,        False),
(80, 'uv_indice',       'uv',               'UV',                 null,        null,     0,   false,   0,     true,    0,      true,   false,    null,      true,            null,        False),
(82, 'voltage',         'voltage',          'consBatteryVoltage', null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
(84, 'wind 10',         'wind10',           'windSpeed',          'wind',        86,     0,  false,    0,     true,    0,      true,   false,    null,      true,            null,        False),
(86, 'wind 10 dir',     'wind10_dir',       'windSpeed',          'skip',      null,     0,  false,    0,    false,    0,      true,   false,    null,      true,            null,        False),
-- (87, 'wind 10 omm',     'wind10_omm',       'windSpeed',          'wind',      null,     0,   true,    0,     true,    0,      true,   false,      84,      true,            null,        False),
(88, 'wind',            'wind',             'windSpeed',          'wind',        90,     0,   false,   0,     true,    0,      true,   false,    null,      true,            null,        False),
(90, 'wind dir',        'wind_dir',         'windDir',            'skip',      null,     0,   false,   0,    false,    0,      true,   false,    null,      true,            null,        False),
(92, 'windchill',       'windchill',        'windchill',          null,        null,     0,   true,    0,    false,    0,      true,   false,    null,      true,            null,        False)
; 

select 'nb postes: ' || count(*) from postes;
select 'nb mesures: ' || count(*) from mesures;

-- get last values
-- select poste_id, name, last(date_local, mesure_id), last(avg, mesure_id)  from obs_month join mesures on mesures.id = mesure_id group by 1,2 order by 1,2;

create materialized view obs_hour WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 hour', date_local, origin => '1950-01-01') as date_local,
        poste_id as poste_id,
        mesure_id as mesure_id,
        sum(duration) as duration,
        avg(value) as value
  from obs
  where qa_value != 9
  group by 1,2,3;

create materialized view obs_day WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 day', date_local, origin => '1950-01-01') as date_local,
        poste_id as poste_id,
        mesure_id as mesure_id,
        sum(duration) as duration,
        avg(value) as value
  from obs_hour
  group by 1,2,3;

create materialized view obs_month WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 month', date_local, origin => '1950-01-01') as date_local,
        poste_id,
        mesure_id,
        sum(duration) as duration,
        avg(value) as value
  from obs_day
  group by 1,2,3;

create materialized view x_min_day WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 day', date_local, origin => '1950-01-01') as date_local,
        poste_id as poste_id,
        mesure_id as mesure_id,
        min(min) as min,
        first(min_time, min) as min_time
  from x_min
  where qa_min != 9
  group by 1,2,3;

create materialized view x_min_month WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 month', date_local, origin => '1950-01-01') as date_local,
        poste_id as poste_id,
        mesure_id as mesure_id,
        min(min) as min,
        first(min_time, min) as min_time
  from x_min_day
 group by 1,2,3;

create materialized view x_max_day WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 day', date_local, origin => '1950-01-01') as date_local,
        poste_id as poste_id,
        mesure_id as mesure_id,
        max(max) as max,
        last(max_time, max) as max_time
  from x_max
  where qa_max != 9
  group by 1,2,3;

create materialized view x_max_month WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 month', date_local, origin => '1950-01-01') as date_local,
        poste_id as poste_id,
        mesure_id as mesure_id,
        max(max) as max,
        last(max_time, max) as max_time
  from x_max_day
  group by 1,2,3;

-- create materialized view compare_month WITH (timescaledb.continuous) as
-- materialized view does not support left join...

--  select
--         timescaledb_experimental.time_bucket_ng('1 month', o.date_local, origin => '1950-01-01') as date_local,
--         o.poste_id,
--         avg(o.value) as avg_value,
--         min(mi.min),
--         first(mi.min_time, mi.min) as min_time,
--         max(ma.max),
--         last(ma.max_time, ma.max) as max_time
--     from obs_month o 
--       left join x_min_month mi on 
--         o.poste_id = mi.poste_id
--         and o.mesure_id = mi.mesure_id
--         and timescaledb_experimental.time_bucket_ng('1 month', mi.date_local, origin => '1950-01-01') = timescaledb_experimental.time_bucket_ng('1 month', mi.date_local, origin => '1950-01-01')
--       left join x_max_month ma on 
--         o.poste_id = ma.poste_id
--         and o.mesure_id = ma.mesure_id
--         and timescaledb_experimental.time_bucket_ng('1 month', ma.date_local, origin => '1950-01-01') = timescaledb_experimental.time_bucket_ng('1 month', ma.date_local, origin => '1950-01-01')
--     where o.mesure_id = 1
-- --       Important to add a where on each table => 
-- --           timescale can limit the search in the underlying chunks for each table
--       and o.date_local > '202-12-01'
--       and mi.date_local > '202-12-01'
--       and ma.date_local > '202-12-01'
--     group by 1,2;

-- ---------
-- Triggers
-- ---------
/*
*  maintain last_obs_date/id in poste table
*  cascade qa_value to x_min/x_max tables
*/ 
CREATE OR REPLACE FUNCTION create_update_obs_trigger_fn()
  RETURNS TRIGGER LANGUAGE PLPGSQL AS
$BODY$
DECLARE
    obs_dat timestamp;
BEGIN
  select last_obs_date  into obs_dat from postes where id = NEW.poste_id;
  if new.duration > 0 and (obs_dat is null or new.date_utc > obs_dat) then
    update postes set last_obs_date = NEW.date_utc, last_obs_id = NEW.id where id = NEW.poste_id;
  end if;
  if NEW.qa_value <> OLD.qa_value then
    update x_min set qa_min = NEW.qa_value where obs_id = NEW.id;
    update x_max set qa_max = NEW.qa_value where obs_id = NEW.id;
  end if;
  return NEW;
END
$BODY$;

CREATE OR REPLACE TRIGGER create_update_obs_trigger
  AFTER INSERT OR UPDATE ON obs
  FOR EACH ROW EXECUTE PROCEDURE create_update_obs_trigger_fn();

/*
*  cascade delete obs to x_min/x_max
*/ 
CREATE OR REPLACE FUNCTION delete_obs_trigger_fn()
  RETURNS TRIGGER LANGUAGE PLPGSQL AS
$BODY$
DECLARE
BEGIN
    delete from x_min where obs_id = OLD.id;
    delete from x_max where obs_id = OLD.id;
  return OLD;
END
$BODY$;

CREATE OR REPLACE TRIGGER delete_obs_trigger
  AFTER INSERT OR UPDATE ON x_max
  FOR EACH ROW EXECUTE PROCEDURE delete_obs_trigger_fn();


-- CREATE OR REPLACE FUNCTION get_last_obs(pid integer)
-- RETURNS TABLE(poste_id smallint, ) LANGUAGE plpgsql
-- AS $$
-- DECLARE
--   select last(date_local, mesure_id) as date_local, last(avg, mesure_id) as mesure_id
--     from obs_month join mesures on mesures.id = mesure_id
--     where poste_id = pid
--     group by 1,2
--     order by 1,2;
-- END;
-- $$
-- ;

/*
Id_station;Id_omm;Nom_usuel;Latitude;Longitude;Altitude;Date_ouverture;Pack
97401520;;LE TEVELAVE;-21.211667;55.361333;908;1953-01-01;ETENDU
97401540;;LES AVIRONS - CIRAD;-21.239500;55.327500;180;1952-01-01;ETENDU
97402240;;BELLEVUE BRAS-PANON;-21.005000;55.622667;480;1990-09-01;RADOME
97403410;;LE DIMITILE_SAPC;-21.189000;55.481500;1808;2013-09-27;ETENDU
97403435;;BRAS-LONG_SAPC;-21.228333;55.474667;510;2013-05-22;ETENDU
97404540;;PONT-MATHURIN;-21.265000;55.380000;19;1961-06-01;RADOME
97405420;;PITON-BLOC_SAPC;-21.321167;55.572333;812;1990-01-01;ETENDU
97406220;;PLAINE DES PALMISTES;-21.136167;55.627167;1032;1952-01-01;RADOME
97407520;61981;LE PORT;-20.946167;55.282000;9;1971-04-18;RADOME
97408510;;POSSESSION;-20.921333;55.346167;9;1997-10-01;ETENDU
97408560;;AURERE_SAPC;-21.018833;55.424833;940;1952-01-01;ETENDU
97408580;;LA NOUVELLE_SAPC;-21.076667;55.423333;1415;1970-01-01;ETENDU
97408582;;DOS D'ANE;-20.978500;55.390500;1027;2022-05-02;ETENDU
97409210;;BOIS-ROUGE;-20.913667;55.641333;5;1952-01-01;ETENDU
97409230;;LE COLOSSE;-20.934500;55.664500;16;1957-03-01;RADOME
97409240;;MENCIOL;-20.961167;55.625667;181;1953-01-01;ETENDU
97410202;;BEAUVALLON;-21.008000;55.693333;16;1952-01-01;ETENDU
97410238;;SAINT-BENOIT;-21.058833;55.719333;43;1952-01-01;RADOME
97410250;;TAKAMAKA - PK12_SAPC;-21.076333;55.630833;660;1971-11-01;ETENDU
97410265;;CHEMIN DE CEINTURE_SAPC;-21.076333;55.685500;255;2003-07-24;ETENDU
97411132;;CHAUDRON;-20.897000;55.495000;38;1967-01-01;ETENDU
97411141;;GRANDE-CHALOUPE;-20.898333;55.369833;10;1997-10-01;ETENDU
97411146;;COLORADO_SAPC;-20.910500;55.421500;702;2003-02-26;ETENDU
97411150;;SAINT-FRANCOIS;-20.921333;55.456333;545;1953-03-01;ETENDU
97411155;;MONTAUBAN_SAPC;-20.938667;55.496833;420;2009-09-29;ETENDU
97411164;;LE BRULE - VAL FLEURI_SAPC;-20.941667;55.429500;1069;1956-09-01;ETENDU
97411170;;PLAINE DES CHICOTS_SAPC;-20.987333;55.444833;1834;1982-01-01;ETENDU
97412302;;COMMERSON_SAPC;-21.208000;55.643667;2310;1968-01-01;ETENDU
97412336;;GRAND-COUDE_SAPC;-21.301667;55.631333;1085;1978-01-01;ETENDU
97412340;;GRAND-GALET;-21.311000;55.639500;505;1953-08-06;ETENDU
97412356;;LA CRETE_SAPC;-21.337500;55.667667;659;1968-10-01;ETENDU
97412384;;ST-JOSEPH_SAPC;-21.385167;55.609667;13;1960-04-01;ETENDU
97412801;;ST JOSEPH-CIRAD;-21.385167;55.609667;13;2021-10-05;ETENDU
97413520;;COLIMACONS;-21.130333;55.304667;798;1963-08-01;RADOME
97413542;;ST-LEU;-21.190000;55.292333;79;1950-10-01;ETENDU
97413545;;SAINT-LEU - CIRAD;-21.187333;55.300833;222;1997-01-01;ETENDU
97413550;;ETANG SAINT-LEU - CIRAD;-21.173333;55.308833;429;2002-02-01;ETENDU
97413580;;PITON SAINT-LEU_SAPC;-21.215167;55.325833;530;1973-02-01;ETENDU
97414409;;PLAINE DES MAKES_SAPC;-21.199500;55.409167;980;2004-12-29;ETENDU
97414431;;LE GOL LES HAUTS - CIRAD;-21.245833;55.428000;365;1997-01-01;ETENDU
97414451;;LE TAPAGE - CIRAD;-21.224667;55.444167;863;2002-03-25;ETENDU
97415516;;BOIS DE NEFLES ST-PAUL_SAPC;-20.997500;55.341167;595;1952-01-01;ETENDU
97415536;;PETITE-FRANCE;-21.045000;55.342000;1200;1999-09-01;RADOME
97415541;;TAN-ROUGE_SAPC;-21.069167;55.299667;750;1960-01-01;ETENDU
97415550;;L'ERMITAGE - CIRAD;-21.053000;55.241333;147;2002-05-01;ETENDU
97415557;;LE GUILLAUME;-21.064667;55.324333;1035;1953-01-01;ETENDU
97415566;;PITON-MAIDO;-21.076667;55.381167;2150;1998-11-18;RADOME
97415590;;POINTE DES TROIS-BASSINS;-21.105167;55.247667;5;1987-10-02;RADOME
97415592;;TAN ROUGE-CIRAD;-21.069167;55.299667;746;2021-06-02;ETENDU
97416410;;RAVINE DES CABRIS - CIRAD;-21.274500;55.475333;310;1997-01-01;ETENDU
97416463;;PIERREFONDS-AEROPORT;-21.320000;55.425500;21;1999-01-01;RADOME
97416465;;LIGNE-PARADIS - CIRAD;-21.319167;55.485167;156;1966-01-01;ETENDU
97417340;;LE TREMBLET;-21.317333;55.801000;91;1953-01-01;ETENDU
97417360;;LE BARIL;-21.359000;55.732167;114;1989-02-01;RADOME
97418110;61980;GILLOT-AEROPORT;-20.892167;55.528667;8;1953-01-01;RADOME
97418123;;LA MARE - CIRAD;-20.903500;55.532000;68;2001-01-01;ETENDU
97418170;;PLAINE DES FOUGERES_SAPC;-20.967333;55.527833;1064;1993-06-01;ETENDU
97419310;;RIVIERE DE L'EST - CIRAD;-21.120167;55.758667;144;1953-01-01;ETENDU
97419320;;HAUTS DE SAINTE-ROSE_SAPC;-21.159500;55.763667;820;1973-07-01;ETENDU
97419350;;GROS PITON SAINTE-ROSE;-21.179500;55.828833;181;1987-09-01;RADOME
97419380;;BELLECOMBE-JACOB;-21.217833;55.687000;2245;1966-11-01;RADOME
97420110;;GRAND-HAZIER - CIRAD;-20.902833;55.586000;69;1953-01-01;ETENDU
97420150;;BAGATELLE_SAPC;-20.931000;55.576667;262;1953-01-01;ETENDU
97420180;;BRAS-PISTOLET_SAPC;-20.969000;55.587500;556;2002-12-01;ETENDU
97421210;;MARE A VIEILLE PLACE;-21.027833;55.512167;870;1989-07-01;ETENDU
97421220;;GRAND-ILET_SAPC;-21.028667;55.471667;1185;1973-07-01;ETENDU
97421240;;SALAZIE-VILLAGE_SAPC;-21.031667;55.538500;476;1996-01-01;ETENDU
97421260;;BELOUVE_SAPC;-21.060833;55.536500;1500;1955-09-01;ETENDU
97421265;;ILET A VIDOT_SAPC;-21.063167;55.510333;940;2003-12-01;ETENDU
97422440;;PLAINE DES CAFRES;-21.209167;55.572833;1560;1948-01-01;RADOME
97422445;;BRAS-SEC;-21.205667;55.525167;1210;1969-11-15;ETENDU
97422455;;PONT D'YVES;-21.231333;55.503167;835;1977-07-19;ETENDU
97422465;;LE TAMPON - CIRAD;-21.251667;55.530333;860;1958-01-01;ETENDU
97424410;;CILAOS;-21.134167;55.471667;1197;1952-01-01;RADOME
97424450;;ILET A CORDES_SAPC;-21.153500;55.438167;1067;1977-08-08;ETENDU
97424460;;PALMISTE-ROUGE;-21.168667;55.474500;830;1962-01-01;ETENDU
*/