
insert into postes(meteor, delta_timezone, meteofr, title, owner, email, phone, address, zip, city, country, altitude, lat, long, load_json) values
('BAG280',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0,  -20.933387, 55.582768, false),
('BBF015',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, 0, 0, false),
('BDN240',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, 0, 0, false),
('BER590',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, -21.309871, 55.537723, false),
('BOCO1370', 4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0,  -21.196061, 55.53827, false),
('BOMU1610', 4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, -21.192665, 55.576251, false),
('BP130',    4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, 0, 0, false),
('BRT155',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, -20.912244, 55.493962, false),
('BRT240',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0,  0, 0, false),
('CAM015',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, -20.961875, 55.282956, false),
('CHAR645',  4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, -21.33028, 55.567254, false),
('CHP690',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, 0, 0, false),
('ELH675',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0,  -20.950965, 55.516872, false),
('ESB005',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, -21.267795, 55.335286, false),
('ESH555',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, -21.236787, 55.378695, false),
('FAY040',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, -20.941706, 55.65897, false),
('GDC030',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, -20.95888, 55.689574, false),
('LAN030',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0,  -20.895952, 55.572072, false),
('LCV050',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0,  -20.895952, 55.572072, false),
('MAT315',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, -21.360229, 55.70152, false),
('MTG280',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, -20.878348, 55.428241, false),
('MTG320',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, -20.882, 55.424667, false),
('MVP860',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0,  -21.025844, 55.515549, false),
('NDLP1520', 4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, 0, 0, false),
('PAH575',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0,  -21.300325, 55.418679, false),
('PFD040',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0,  -21.300325, 55.418679, false),
('PSL310',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0,  -21.300325, 55.418679, false),
('RAM450',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0,  -20.928899, 55.365116, false),
('ROQ070',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, -21.059036, 55.229183, false),
('SPC010',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, -21.053141, 55.695668, false),
('SBBM100',  4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, -21.053141, 55.695668, false),
('TAM1790',  4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0,  -21.106126, 55.362666, false),
('TAN1270',  4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0,  -21.106126, 55.362666, false),
('TAR600',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0,  -21.059972, 55.289673, false),
('TBL105',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, -21.317372, 55.800674, false),
('TRG170',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, -21.338827, 55.51276, false),
('TRM490',   4, 'meteofr', 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'rue de la montagne','97400', 'montagne', 'la réunion',  0, -21.26666, 55.495548, false)
;
/*
  name:
  json_input: field name in json coming from weewx, and in Obs table
  archive_col: field name in weew archive database
  archive_table: table name when different than archive_col...
  field_dir: field for wind direction (not in omm measure)
  val_deca: decallage de la mesure
  min: compute a min in extreme table
  min_deca: decallage du min
  max: compute a max in extreme table
  max_deca: decallage du max
  is_avg:
  is_wind: is it a wind measure (need to find the winddir data)
  omm_link: for omm measure, link to the base measure
  allow_zero: not used...
  json_input_bis: ??
  is_houly: is data in json coming from weewx is a value for the full hour (etp)
*/
insert into mesures
(id,    name,            json_input,         archive_col,   archive_table, field_dir, val_deca, min, min_deca, max,  max_deca, is_avg, is_wind, omm_link, allow_zero,     json_input_bis, is_hourly) values
( 1, 'barometer',       'barometer',        'barometer',          null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
( 4, 'barometer omm',   'barometer_omm',    'barometer',          null,        null,     0,   true,    0,     true,    0,      true,   false,       1,      true,            null,        False),
( 6, 'dewpoint',        'dewpoint',         'dewpoint',           null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
( 8, 'etp',             'etp',              'ET',                 null,        null,     0,   true,    0,     true,    0,      false,  false,    null,      true,            null,         True),
(10, 'extra_temp1',     'extra_temp1',      'extraTemp1',         null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(12, 'extra_temp2',     'extra_temp2',      'extraTemp2',         null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(14, 'extra_temp3',     'extra_temp3',      'extraTemp3',         null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(16, 'extrahumid1',     'extra_humid1',     'extraHumid1',        null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(18, 'extrahumid2',     'extra_humid2',     'extraHumid2',        null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(20, 'gust',            'wind_gust',        'windGust',           'wind',        22,     0,   false,   0,     true,    0,      true,   true,     null,      true,      'wind_max',        False),
(22, 'gust dir',        'wind_gust_dir',    'windGustDir',        'skip',      null,     0,   false,   0,     false,   0,      true,   false,    null,      true,  'wind_max_dir',        False),
(24, 'hail rate',       'hail_rate',        'hailRate',           null,        null,     0,   false,   0,     true,    0,      true,   false,    null,      true,            null,        False),
(26, 'hail',            'hail',             'hail',               null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
(28, 'heatindex',       'heatindex',        'heatindex',          null,        null,     0,   false,   0,     true,    0,      true,   false,    null,      true,            null,        False),
(30, 'heating temp',    'heating_temp',     'heatingTemp',        null,        null,     0,   false,   0,     true,    0,      true,   false,    null,      true,            null,        False),
(32, 'humidity inside', 'in_humidity',      'inHumidity',         null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
(34, 'humidity',        'out_humidity',     'outHumidity',        null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,      'humidity',        False),
(36, 'humidity omm',    'out_humidity_omm', 'outHumidity',        null,        null,     0,   true,    0,     true,    0,      true,   false,      34,      true,  'humidity_omm',        False),
(38, 'leaftemp1',       'leaf_temp1',       'leafTemp1',          null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,      'leaftemp',        False),
(40, 'leaftemp2',       'leaf_temp2',       'leafTemp2',          null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(42, 'leafwet1',        'leaf_wet1',        'leafWet1',           null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,       'leafwet',        False),
(44, 'leafwet2',        'leaf_wet2',        'leafWet2',           null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(46, 'pressure',        'pressure',         'pressure',           null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
(48, 'radiation',       'radiation',        'radiation',          null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
(50, 'rain rate',       'rain_rate',        'rainRate',           null,        null,     0,   false,   0,     true,    0,      true,   false,    null,      true,            null,        False),
(52, 'rain',            'rain',             'rain',               null,        null,     0,   true,    0,     true,    0,      false,  false,    null,      true,            null,        False),
(54, 'rain omm',        'rain_omm',         'rain',               null,        null,    -7,   false,   0,     true,    7,      false,  false,      52,      true,            null,        False),
(56, 'rx',              'rx',               'rxCheckPercent',     null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
(58, 'soilmoist1',      'soil_moist1',      'soilMoist1',         null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,     'soilmoist',        False),
(60, 'soilmoist2',      'soil_moist2',      'soilMoist2',         null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(62, 'soilmoist3',      'soil_moist3',      'soilMoist3',         null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(64, 'soilmoist4',      'soil_moist4',      'soilMoist4',         null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(66, 'soiltemp1',       'soil_temp1',       'soilTemp1',          null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,      'soiltemp',        False),
(68, 'soiltemp2',       'soil_temp2',       'soilTemp2',          null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(70, 'soiltemp3',       'soil_temp3',       'soilTemp3',          null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(72, 'soiltemp4',       'soil_temp4',       'soilTemp4',          null,        null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(74, 'temp inside',     'in_temp',          'inTemp',             null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
(76, 'temperature',     'out_temp',         'outTemp',            null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
(78, 'temp omm',        'out_temp_omm',     'outTemp',            null,        null,     0,   true,    5,     true,   -7,      true,   false,      76,      true,            null,        False),
(80, 'uv_indice',       'uv',               'UV',                 null,        null,     0,   false,   0,     true,    0,      true,   false,    null,      true,            null,        False),
(82, 'voltage',         'voltage',          'consBatteryVoltage', null,        null,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
(84, 'wind 10',         'wind10',           'windSpeed',          'wind',        90,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
(86, 'wind 10 omm',     'wind10_omm',       'windSpeed',          'wind',      null,     0,   true,    0,     true,    0,      true,   false,      84,      true,            null,        False),
(88, 'wind',            'wind',             'windSpeed',          'wind',        90,     0,   true,    0,     true,    0,      true,   false,    null,      true,            null,        False),
(90, 'wind dir',        'wind_dir',         'windDir',            'skip',      null,     0,   false,   0,     false,   0,      true,   false,    null,      true,            null,        False),
(92, 'windchill',       'windchill',        'windchill',          null,        null,     0,   true,    0,     false,   0,      true,   false,    null,      true,            null,        False)
;

select 'nb postes: ' || count(*) from postes;
select 'nb mesures: ' || count(*) from mesures;

create materialized view obs_day WITH (timescaledb.continuous) as
    select
        timescaledb_experimental.time_bucket_ng('1 day', date_local) as date_local,
        poste_id,
        avg(barometer) as barometer,
        avg(barometer_omm) as barometer_omm,
        avg(dewpoint) as dewpoint,
        sum(etp) as etp,
        avg(extra_humid1) as extra_humid1,
        avg(extra_humid2) as extra_humid2,
        avg(extra_temp1) as extra_temp1,
        avg(extra_temp2) as extra_temp2,
        avg(extra_temp3) as extra_temp3,
        avg(hail) as hail,
        avg(hail_rate) as hail_rate,
        avg(heatindex) as heatindex,
        avg(heating_temp) as heating_temp,
        avg(in_humidity) as in_humidity,
        avg(in_temp) as in_temp,
        avg(leaf_temp1) as leaf_temp1,
        avg(leaf_temp2) as leaf_temp2,
        avg(leaf_wet1) as leaf_wet1,
        avg(leaf_wet2) as leaf_wet2,
        avg(out_humidity) as out_humidity,
        avg(out_humidity_omm) as out_humidity_omm,
        avg(out_temp) as out_temp,
        avg(out_temp_omm) as out_temp_omm,
        avg(pressure) as pressure,
        max(radiation) as radiation,
        sum(rain) as rain,
        sum(rain_omm) as rain_omm,
        avg(rain_rate) as rain_rate,
        avg(rx) as rx,
        avg(soil_moist1) as soil_moist1,
        avg(soil_moist2) as soil_moist2,
        avg(soil_moist3) as soil_moist3,
        avg(soil_moist4) as soil_moist4,
        avg(soil_temp1) as soil_temp1,
        avg(soil_temp2) as soil_temp2,
        avg(soil_temp3) as soil_temp3,
        avg(soil_temp4) as soil_temp4,
        max(uv) as uv,
        avg(voltage) as voltage,
        avg(wind) as wind,
        max(wind_gust) as wind_gust,
        avg(wind10) as wind10,
        avg(wind10_omm) as wind10_omm,
        avg(windchill) as windchill
    from obs
    group by 1,2;


CREATE OR REPLACE FUNCTION create_obs_trigger_fn()
  RETURNS TRIGGER LANGUAGE PLPGSQL AS
$BODY$
DECLARE
    obs_dat timestamp;
BEGIN
  select last_obs_date  into obs_dat from postes where id = NEW.poste_id;
  if new.duration > 0 and (obs_dat is null or new.date_local > obs_dat) then
    update postes set last_obs_date = NEW.date_local, last_obs_id = NEW.id where id = NEW.poste_id;
  end if;
  return NEW;
END
$BODY$;

/*
*  store in each poste the id and time for the most recent obs
*/ 
CREATE TRIGGER create_obs_trigger
  AFTER INSERT OR UPDATE ON obs
  FOR EACH ROW EXECUTE PROCEDURE create_obs_trigger_fn();


CREATE OR REPLACE FUNCTION create_extremes_trigger_fn()
  RETURNS TRIGGER LANGUAGE PLPGSQL AS
$BODY$
DECLARE
    x_dat timestamp;
BEGIN
  select last_extremes_date  into x_dat from postes where id = NEW.poste_id;
  if x_dat is null or new.date_local > x_dat then
    update postes set last_extremes_date = NEW.date_local, last_extremes_id = NEW.id where id = NEW.poste_id;
  end if;
  return NEW;
END
$BODY$;

/*
*  store in each poste the id and time for the most recent obs
*/ 
CREATE OR REPLACE TRIGGER create_extremes_trigger
  AFTER INSERT OR UPDATE ON extremes
  FOR EACH ROW EXECUTE PROCEDURE create_extremes_trigger_fn();

-- CREATE OR REPLACE FUNCTION delete_obs_trigger_fn()
--   RETURNS TRIGGER LANGUAGE PLPGSQL AS
-- $BODY$
-- DECLARE
-- BEGIN
--     delete from extremes where id_obs = OLD.id;

--     if OLD.id_obs is null then
--         delete from obs where id_obs = OLD.id;
-- 	end if;
--   return OLD;
-- END
-- $BODY$;


-- /*
-- *  delete cascase linked obs, and linked extremes
-- */ 
-- CREATE TRIGGER delete_obs_trigger
--   AFTER DELETE ON obs
--   FOR EACH ROW EXECUTE PROCEDURE delete_obs_trigger_fn();


CREATE OR REPLACE FUNCTION get_last_obs(pid integer)
RETURNS json LANGUAGE plpgsql
AS $$
DECLARE
    tmp_str text;
    j_result json;
    v_barometer float;
    v_barometer_omm float;
    v_dewpoint float;
    v_etp float;
    v_extra_humid1 float;
    v_extra_humid2 float;
    v_extra_temp1 float;
    v_extra_temp2 float;
    v_extra_temp3 float;
    v_hail float;
    v_hail_rate float;
    v_heatindex float;
    v_heating_temp float;
    v_in_humidity float;
    v_in_temp float;
    v_leaf_temp1 float;
    v_leaf_temp2 float;
    v_leaf_wet1 float;
    v_leaf_wet2 float;
    v_out_humidity float;
    v_out_humidity_omm float;
    v_out_temp float;
    v_out_temp_omm float;
    v_pressure float;
    v_radiation float;
    v_rain float;
    v_rain_omm float;
    v_rain_rate float;
    v_rx float;
    v_soil_moist1 float;
    v_soil_moist2 float;
    v_soil_moist3 float;
    v_soil_moist4 float;
    v_soil_temp1 float;
    v_soil_temp2 float;
    v_soil_temp3 float;
    v_soil_temp4 float;
    v_uv float;
    v_voltage float;
    v_wind float;
    v_wind_gust float;
    v_wind10 float;
    v_wind10_omm float;
    v_windchill float;
BEGIN
    tmp_str = '';

    select barometer, barometer_omm, dewpoint, etp, extra_humid1,
           extra_humid2, extra_temp1, extra_temp2, extra_temp3, hail,
           hail_rate, heatindex, heating_temp, in_humidity, in_temp,
           leaf_temp1, leaf_temp2, leaf_wet1, leaf_wet2, out_humidity,
           out_humidity_omm, out_temp, out_temp_omm, pressure, radiation,
           rain, rain_omm, rain_rate, rx, soil_moist1,
           soil_moist2, soil_moist3, soil_moist4, soil_temp1, soil_temp2,
           soil_temp3, soil_temp4, uv, voltage, wind,
           wind_gust, wind10, wind10_omm, windchill
    into
        v_barometer, v_barometer_omm, v_dewpoint, v_etp, v_extra_humid1,
        v_extra_humid2, v_extra_temp1, v_extra_temp2, v_extra_temp3, v_hail,
        v_hail_rate, v_heatindex, v_heating_temp, v_in_humidity, v_in_temp,
        v_leaf_temp1, v_leaf_temp2, v_leaf_wet1, v_leaf_wet2, v_out_humidity,
        v_out_humidity_omm, v_out_temp, v_out_temp_omm, v_pressure, v_radiation,
        v_rain, v_rain_omm, v_rain_rate, v_rx, v_soil_moist1,
        v_soil_moist2, v_soil_moist3, v_soil_moist4, v_soil_temp1, v_soil_temp2,
        v_soil_temp3, v_soil_temp4, v_uv, v_voltage, v_wind,
        v_wind_gust, v_wind10, v_wind10_omm, v_windchill

    from obs where id = (select last_obs_id from postes where id = pid);

    if v_barometer is not null then tmp_str = concat(tmp_str, ', "barometer", ', v_barometer); end if;        
    if v_dewpoint is not null then tmp_str = concat(tmp_str, ', "dewpoint", ', v_dewpoint); end if;
    if v_etp is not null then tmp_str = concat(tmp_str, ', "etp", ', v_etp); end if;
    if v_extra_humid1 is not null then tmp_str = concat(tmp_str, ', "extra_humid1", ', v_extra_humid1); end if;
    if v_extra_humid2 is not null then tmp_str = concat(tmp_str, ', "extra_humid2", ', v_extra_humid2); end if;
    if v_extra_temp1 is not null then tmp_str = concat(tmp_str, ', "extra_temp1", ', v_extra_temp1); end if;
    if v_extra_temp2 is not null then tmp_str = concat(tmp_str, ', "extra_temp2", ', v_extra_temp2); end if;
    if v_extra_temp3 is not null then tmp_str = concat(tmp_str, ', "extra_temp3", ', v_extra_temp3); end if;
    if v_hail is not null then tmp_str = concat(tmp_str, ', "hail", ', v_hail); end if;
    if v_hail_rate is not null then tmp_str = concat(tmp_str, ', "hail_rate", ', v_hail_rate); end if;
    if v_heatindex is not null then tmp_str = concat(tmp_str, ', "heatindex", ', v_heatindex); end if;
    if v_heating_temp is not null then tmp_str = concat(tmp_str, ', "heating_temp", ', v_heating_temp); end if;
    if v_in_humidity is not null then tmp_str = concat(tmp_str, ', "in_humidity", ', v_in_humidity); end if;
    if v_in_temp is not null then tmp_str = concat(tmp_str, ', "in_temp", ', v_in_temp); end if;
    if v_leaf_temp1 is not null then tmp_str = concat(tmp_str, ', "leaf_temp1", ', v_leaf_temp1); end if;
    if v_leaf_temp2 is not null then tmp_str = concat(tmp_str, ', "leaf_temp2", ', v_out_temp); end if;
    if v_leaf_wet1 is not null then tmp_str = concat(tmp_str, ', "leaf_wet1", ', v_leaf_wet1); end if;
    if v_leaf_wet2 is not null then tmp_str = concat(tmp_str, ', "leaf_wet2", ', v_leaf_wet2); end if;
    if v_out_temp is not null then tmp_str = concat(tmp_str, ', "out_temp", ', v_out_temp); end if;
    if v_out_humidity is not null then tmp_str = concat(tmp_str, ', "out_humidity", ', v_out_humidity); end if;
    if v_pressure is not null then tmp_str = concat(tmp_str, ', "pressure", ', v_pressure); end if;
    if v_rain is not null then tmp_str = concat(tmp_str, ', "rain", ', v_rain); end if;
    if v_rain_rate is not null then tmp_str = concat(tmp_str, ', "rain_rate", ', v_rain_rate); end if;
    if v_rx is not null then tmp_str = concat(tmp_str, ', "rx", ', v_rx); end if;
    if v_soil_moist1 is not null then tmp_str = concat(tmp_str, ', "soil_moist1", ', v_soil_moist1); end if;
    if v_soil_moist2 is not null then tmp_str = concat(tmp_str, ', "soil_moist2", ', v_soil_moist2); end if;
    if v_soil_moist3 is not null then tmp_str = concat(tmp_str, ', "soil_moist3", ', v_soil_moist3); end if;
    if v_soil_moist4 is not null then tmp_str = concat(tmp_str, ', "soil_moist4", ', v_soil_moist4); end if;
    if v_soil_temp1 is not null then tmp_str = concat(tmp_str, ', "soil_temp1", ', v_soil_temp1); end if;
    if v_soil_temp2 is not null then tmp_str = concat(tmp_str, ', "soil_temp2", ', v_soil_temp2); end if;
    if v_soil_temp3 is not null then tmp_str = concat(tmp_str, ', "soil_temp3", ', v_soil_temp3); end if;
    if v_soil_temp4 is not null then tmp_str = concat(tmp_str, ', "soil_temp4", ', v_soil_temp4); end if;
    if v_uv is not null then tmp_str = concat(tmp_str, ', "uv", ', v_uv); end if;
    if v_voltage is not null then tmp_str = concat(tmp_str, ', "voltage", ', v_voltage); end if;
    if v_wind is not null then tmp_str = concat(tmp_str, ', "wind", ', v_wind); end if;
    if v_wind_gust is not null then tmp_str = concat(tmp_str, ', "wind_gust", ', v_wind_gust); end if;
    if v_wind10 is not null then tmp_str = concat(tmp_str, ', "wind10", ', v_wind10); end if;
    if v_windchill is not null then tmp_str = concat(tmp_str, ', "windchill", ', v_windchill); end if;

	tmp_str = substring(tmp_str, 2);
    tmp_str = concat('{', tmp_str, '}');

    select json_object(tmp_str::text[]) into j_result;
    return j_result;
END;
$$
;
