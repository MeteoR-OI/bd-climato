
insert into postes
(meteor, delta_timezone, data_source, type, owner, email, phone, quartier, city, country, altitude, lat, long, load_type) values
('BAG280',   4, 0, 'station VP2', 'Micolas Cuvillier', 'micka@meteor-oi.re', '0612345678', 'Bain Boeuf', 'Bain boeuf', 'Maurice',  0,  -20.933387, 55.582768, 1),
('BBF015',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, 0, 0, 1),
('BDN240',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, 0, 0, 1),
('BER590',   4, 0, 'station VP2', 'Sabine/Pierre', 'micka@meteor-oi.re', '0612345678', 'Bérive 590', 'Le Tampon', 'la réunion',  590, -21.309871, 55.537723, 1),
('BER605',   4, 0, 'station VP2', 'Véronique', 'micka@meteor-oi.re', '0612345678', 'Bérive 605', 'Le Tampon', 'la réunion',  605, -21.30833, 55.53887, 1),
('BOCO1370', 4, 0, 'station VP2', 'Donny', 'micka@meteor-oi.re', '0612345678', 'Bois court', 'Le Tampon', 'la réunion',  1370,  -21.196061, 55.53827, 1),
('BOMU1610', 4, 0, 'station VP2', 'Patrice', 'micka@meteor-oi.re', '0612345678', 'Bourg Murat', 'Le Tampon', 'la réunion',  1600, -21.192665, 55.576251, 1),
('BP130',    4, 0, 'station VP2', 'Alexandre Nativel', 'micka@meteor-oi.re', '0612345678', 'Bassin Plat', 'Saint Pierre', 'la réunion',  135, -21.330492, 55.489393, 1),
('BPN100',   4, 0, 'station VP2', 'Ami de Jack Quillet', 'micka@meteor-oi.re', '0612345678', 'La caroline', 'Bras Panon', 'la réunion',  100, -21.002163, 55.652502, 1),
('BRL030',   4, 0, 'station VP2', 'Geoffroy', 'micka@meteor-oi.re', '0612345678', 'Baril', 'Saint Philippe', 'la réunion',  80, -21.362132, 55.725414, 1),
('BRT155',   4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'La Bretagne', 'Saint Denis', 'la réunion',  155, -20.912244, 55.493962, 1),
('BRT240',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  0, 0, 1),
('CAM015',   4, 0, 'station VP2', 'Entreprise Drone', 'micka@meteor-oi.re', '0612345678', 'Cambaie', 'Saint Paul', 'la réunion',  20, -20.961875, 55.282956, 1),
('CBG270',   4, 0, 'station VP2', 'Tony', 'micka@meteor-oi.re', '0612345678', 'Cambourg', 'Saint Benoit', 'la réunion',  260, -21.113488, 55.728536, 1),
('CHAR645',  4, 0, 'station VP2', 'Frederik/Caroline', 'micka@meteor-oi.re', '0612345678', 'Charrié', 'Petite Ile', 'la réunion',  645, -21.192665, 55.576251, 1),
('CHP690',   4, 0, 'station Vue', 'Thiébaut', 'micka@meteor-oi.re', '0612345678', 'La Chapelle/†evelave', 'Les Avirons', 'la réunion', 6900, -21.220226, 55.344443, 1),
('CRT630',   4, 0, 'station Vue', 'Micka', 'micka@meteor-oi.re', '0612345678', 'La Crete 1', 'Saint Joseph', 'la réunion',  630,  -21.335742, 55.656652, 1),
('CRT635',   4, 0, 'station Vue', 'Micka', 'micka@meteor-oi.re', '0612345678', 'La Crete 2', 'Saint Joseph', 'la réunion',  635,  -21.340014, 55.667172, 1),
('CUP575',   4, 0, 'station Vue', 'Vishal', 'micka@meteor-oi.re', '0612345678', 'Curepipe', 'Curepipe', 'Maurice',  575,   -20.933387, 55.582768, 1),
('ELH675',   4, 0, 'station Vue', 'Mat/Actus Meteo 974', 'micka@meteor-oi.re', '0612345678', 'Esperance les hauts', 'Saint Marie', 'la réunion',  670,  -20.950965, 55.516872, 1),
('ESB005',   4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Etang Salé les Bains', 'Etang Salé', 'la réunion',  10, -21.26778775, 55.335363, 1),
('ESH555',   4, 0, 'station VP2', 'Laurent', 'micka@meteor-oi.re', '0612345678', 'Etang Salé', 'Etang Salé', 'la réunion',  555, -21.236787, 55.378695, 1),
('FAY040',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -20.941706, 55.65897, 1),
('GDC030',   4, 0, 'station VP2', 'Sébastien Langlade', 'micka@meteor-oi.re', '0612345678', 'Grand Canal', 'Saint André', 'la réunion',  27, -20.95888, 55.689574, 1),
('GFD010',   4, 0, 'station VP2', 'Thierry François', 'micka@meteor-oi.re', '0612345678', 'Grand Fond', 'Saint Paul', 'la réunion',  10, -21.26778775, 55.219428, 1),
('LAN030',   4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Langevin', 'Saint Joseph', 'la réunion',  40,  -21.384245, 55.647383, 1),
('LCV050',   4, 0, 'station VP2', 'Philippe', 'micka@meteor-oi.re', '0612345678', 'La Convenance', 'Sainte Marie', 'la réunion',  45,  -20.895952, 55.572072, 1),
('MAK805',   4, 0, 'station VP2', 'Jimmy', 'micka@meteor-oi.re', '0612345678', 'Les Makes', 'Saint Louis', 'la réunion',  800, -21.217226, 55.405008, 1),
('MAT315',   4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Matouta', 'Saint Joseph', 'la réunion',  315, -21.360229, 55.70152, 1),
('MDM1570',  4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Marla', 'Saint Paul', 'la réunion',  1570, -21.100918, 55.430022, 1),
('MTG280',   4, 0, 'station VP2', 'Fréderic Caillé', 'micka@meteor-oi.re', '0612345678', 'La Montagne', 'Saint Denis', 'la réunion',  260, -20.878348, 55.428241, 1),
('MTG320',   4, 0, 'station VP2', 'Hubert', 'micka@meteor-oi.re', '0612345678', 'La Montagne', 'Saint Denis', 'la réunion',  320, -20.882, 55.424667, 1),
('MVP860',   4, 0, 'station VP2', 'Jack Quillet', 'micka@meteor-oi.re', '0612345678', 'Mare à Vieille Place', 'Salazie', 'la réunion',  860, -21.025844, 55.515549, 1),
('NDLP1520', 4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Nogtre Dame de la Paix', 'Le Tampon', 'la réunion',  1520, -21.250525, 55.584708, 1),
('PAH575',   4, 0, 'station VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Piton Armand les Hauts', 'Saint Benoit', 'la réunion',  575,  -21.122265, 55.703658, 1),
('PFD040',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  -21.300325, 55.418679, 1),
('PSL310',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  -21.300325, 55.418679, 1),
('RAM450',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  -20.928899, 55.365116, 1),
('ROQ070',   4, 0, 'station Vue', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -21.059036, 55.229183, 1),
('SPC010',   4, 0, 'station Vue', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -21.053141, 55.695668, 1),
('SBBM100',  4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -21.053141, 55.695668, 1),
('TAM1790',  4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  -21.106126, 55.362666, 1),
('TAN1270',  4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  -21.106126, 55.362666, 1),
('TAR600',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0,  -21.059972, 55.289673, 1),
('TBL105',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -21.317372, 55.800674, 1),
('TRG170',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -21.338827, 55.51276, 1),
('TRM490',   4, 0, 'station VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  0, -21.26666, 55.495548, 1)
;
/*
  name:
  json_input: field name in json coming from weewx, and in Obs table
  archive_col: field name in weew archive database
  archive_table: table name when different than archive_col...
  field_dir: field for wind direction (not in omm measure)
  csv_field: column name in csv file
  csv_minmax: min/max in csv. Json with keys: min, minTime, max, maxTime, maxDir
  val_deca: decallage de la mesure OMM
  min: compute a min in extreme table
  min_deca: decallage du min OMM
  max: compute a max in extreme table
  max_deca: decallage du max OMM
  is_avg: if False the measure is a sum
  is_wind: is it a wind measure (need to find the winddir data)
  omm_link: for omm measure, link to the base measure
  allow_zero: not used...
  json_input_bis: ??
  is_houly: is data in json coming from weewx is a value for the full hour (etp)
*/

insert into mesures
(id,    name,            json_input,         archive_col,   archive_table, field_dir,     min,     max,    is_avg, is_wind,  allow_zero,  json_input_bis, is_hourly, convert) values
( 1, 'barometer',       'barometer',        'barometer',          null,        null,     true,    true,     true,   false,    true,            null,        False,    '{}'),
( 6, 'dewpoint',        'dewpoint',         'dewpoint',           null,        null,     true,    true,     true,   false,    true,            null,        False,    '{}'),
( 8, 'etp',             'etp',              'ET',                 null,        null,     true,    true,     false,  false,    true,            null,         True,    '{}'),
(10, 'extra_temp1',     'extra_temp1',      'extraTemp1',         null,        null,     false,   false,    true,   false,    true,    'extratemp1',        False,    '{}'),
(12, 'extra_temp2',     'extra_temp2',      'extraTemp2',         null,        null,     false,   false,    true,   false,    true,    'extratemp2',        False,    '{}'),
(14, 'extra_temp3',     'extra_temp3',      'extraTemp3',         null,        null,     false,   false,    true,   false,    true,    'extratemp3',        False,    '{}'),
(16, 'extrahumid1',     'extra_humid1',     'extraHumid1',        null,        null,     false,   false,    true,   false,    true,   'extrahumid1',        False,    '{}'),
(18, 'extrahumid2',     'extra_humid2',     'extraHumid2',        null,        null,     false,   false,    true,   false,    true,   'extrahumid2',        False,    '{}'),
(20, 'gust',            'wind_gust',        'windGust',           'wind',        22,     false,   true,     true,   true,     true,      'wind_max',        False,
  '{"mfr_csv": "lambda x: x * 3.6"}'),
(22, 'gust dir',        'wind_gust_dir',    'windGustDir',        'skip',      null,     false,   false,    true,   false,    true,  'wind_max_dir',        False,    '{}'),
(24, 'hail rate',       'hail_rate',        'hailRate',           null,        null,     false,   true,     true,   false,    true,            null,        False,    '{}'),
(26, 'hail',            'hail',             'hail',               null,        null,     true,    true,     true,   false,    true,            null,        False,    '{}'),
(28, 'heatindex',       'heatindex',        'heatindex',          null,        null,     false,   true,     true,   false,    true,            null,        False,    '{}'),
(30, 'heating temp',    'heating_temp',     'heatingTemp',        null,        null,     false,   true,     true,   false,    true,            null,        False,    '{}'),
(32, 'humidity inside', 'in_humidity',      'inHumidity',         null,        null,     false,   false,    true,   false,    true,            null,        False,    '{}'),
(34, 'humidity',        'out_humidity',     'outHumidity',        null,        null,     true,    true,     true,   false,    true,      'humidity',        False,    '{}'),
(38, 'leaftemp1',       'leaf_temp1',       'leafTemp1',          null,        null,     false,   false,    true,   false,    true,     'leaftemp1',        False,    '{}'),
(40, 'leaftemp2',       'leaf_temp2',       'leafTemp2',          null,        null,     false,   false,    true,   false,    true,     'leaftemp2',        False,    '{}'),
(42, 'leafwet1',        'leaf_wet1',        'leafWet1',           null,        null,     false,   false,    true,   false,    true,      'leafwet1',        False,    '{}'),
(44, 'leafwet2',        'leaf_wet2',        'leafWet2',           null,        null,     false,   false,    true,   false,    true,      'leafwet2',        False,    '{}'),
(46, 'pressure',        'pressure',         'pressure',           null,        null,     false,   false,    true,   false,    true,            null,        False,    '{}'),
(48, 'radiation',       'radiation',        'radiation',          null,        null,     false,   true,     true,   false,    true,            null,        False,    '{}'),
(50, 'rain rate',       'rain_rate',        'rainRate',           null,        null,     false,   true,     true,   false,    true,            null,        False,    '{}'),
(52, 'rain',            'rain',             'rain',               null,        null,     false,   true,     false,  false,    true,            null,        False,
  '{"weewx": "lambda x: x * 10"}'),
(56, 'rx',              'rx',               'rxCheckPercent',     null,        null,     true,    true,     true,   false,    true,            null,        False,    '{}'),
(58, 'soilmoist1',      'soil_moist1',      'soilMoist1',         null,        null,     false,   false,    true,   false,    true,    'soilmoist1',        False,    '{}'),
(60, 'soilmoist2',      'soil_moist2',      'soilMoist2',         null,        null,     false,   false,    true,   false,    true,    'soilmoist2',        False,    '{}'),
(62, 'soilmoist3',      'soil_moist3',      'soilMoist3',         null,        null,     false,   false,    true,   false,    true,    'soilmoist3',        False,    '{}'),
(64, 'soilmoist4',      'soil_moist4',      'soilMoist4',         null,        null,     false,   false,    true,   false,    true,    'soilmoist4',        False,    '{}'),
(66, 'soiltemp1',       'soil_temp1',       'soilTemp1',          null,        null,     false,   false,    true,   false,    true,     'soiltemp1',        False,    '{}'),
(68, 'soiltemp2',       'soil_temp2',       'soilTemp2',          null,        null,     false,   false,    true,   false,    true,     'soiltemt2',        False,    '{}'),
(70, 'soiltemp3',       'soil_temp3',       'soilTemp3',          null,        null,     false,   false,    true,   false,    true,     'soiltemp3',        False,    '{}'),
(72, 'soiltemp4',       'soil_temp4',       'soilTemp4',          null,        null,     false,   false,    true,   false,    true,     'soiltemp4',        False,    '{}'),
(74, 'temp inside',     'in_temp',          'inTemp',             null,        null,     false,   false,    true,   false,    true,            null,        False,    '{}'),
(76, 'temperature',     'out_temp',         'outTemp',            null,        null,     true,    true,     true,   false,    true,            null,        False,    '{}'),
(80, 'uv_indice',       'uv',               'UV',                 null,        null,     false,   true,     true,   false,    true,            null,        False,    '{}'),
(82, 'voltage',         'voltage',          'consBatteryVoltage', null,        null,     false,   false,    true,   false,    true,            null,        False,    '{}'),
(84, 'wind 10',         'wind10',           'windSpeed',          'wind',        86,     false,   true,     true,   false,    true,            null,        False,
  '{"mfr_csv": "lambda x: x * 3.6"}'),
(86, 'wind 10 dir',     'wind10_dir',       'windSpeed',          'skip',      null,     false,   false,    true,   false,    true,            null,        False,    '{}'),
(88, 'wind',            'wind',             'windSpeed',          'wind',        90,     false,   true,     true,   false,    true,            null,        False,
  '{"mfr_csv": "lambda x: x * 3.6"}'),
(90, 'wind dir',        'wind_dir',         'windDir',            'skip',      null,     false,   false,    true,   false,    true,            null,        False,    '{}'),
(92, 'windchill',       'windchill',        'windchill',          null,        null,     true,    false,    true,   false,    true,            null,        False,    '{}')
;

insert into annotations
(id,time,timeend,text,tags) values
(1,'2022-02-01 00:00:00','2022-02-05 00:00:00','Batsirai','système, cyclone intense'),
(2,'2022-02-19 00:00:00','2022-02-23 00:00:00','Emnati','système, cyclone intense'),
(3,'2018-01-16 12:00:00','2018-01-19 04:00:00','Berguitta','système,cyclone tropical intense'),
(4,'2021-01-11 00:00:00','2021-01-13 12:00:00','Danilo','forte tempête tropicale, système'),
(5,'2021-03-06 00:00:00','2021-03-08 00:00:00','Iman','système,tempête tropicale modérée'),
(6,'2019-12-29 00:00:00','2019-12-31 12:00:00','Calvinia','système, cyclone tropical'),
(7,'2018-03-03 12:00:00','2018-03-06 18:00:00','Dumazile','système, cyclone tropical intense'),
(8,'2019-11-24 00:00:00','2019-11-24 00:00:00','TAR600','première donnée'),
(9,'2011-04-13 00:00:00','2011-04-13 00:00:00','SBBM100','première donnée'),
(10,'2020-09-14 00:00:00','2020-09-14 00:00:00','CHP690','première donnée'),
(11,'2019-09-22 00:00:00','2019-09-22 00:00:00','PFD040','première donnée'),
(12,'2020-01-10 00:00:00','2020-01-10 00:00:00','NDLP1520','première donnée'),
(13,'2020-11-25 00:00:00','2020-11-25 00:00:00','BOCO1370','première donnée'),
(14,'2022-08-23 00:00:00','2022-08-23 00:00:00','BPN100','première donnée'),
(15,'2017-06-10 00:00:00','2017-06-10 00:00:00','BAG280','première donnée'),
(16,'2018-06-30 00:00:00','2018-06-30 00:00:00','ESB005','première donnée'),
(17,'2021-12-10 00:00:00','2021-12-10 00:00:00','TAM1790','première donnée'),
(18,'2013-03-24 00:00:00','2013-03-24 00:00:00','ESH555','première donnée'),
(19,'2020-08-26 00:00:00','2020-08-26 00:00:00','CHAR645','première donnée'),
(20,'2018-02-25 00:00:00','2018-02-25 00:00:00','TRM490','première donnée'),
(21,'2015-06-24 00:00:00','2015-06-24 00:00:00','BBF015','première donnée'),
(22,'2015-06-27 00:00:00','2015-06-27 00:00:00','RAM450','première donnée'),
(23,'2021-09-26 00:00:00','2021-09-26 00:00:00','LCV050','première donnée'),
(24,'2021-05-02 00:00:00','2021-05-02 00:00:00','BER590','première donnée'),
(25,'2019-11-24 00:00:00','2019-11-24 00:00:00','TAN1270','première donnée'),
(26,'2020-12-17 00:00:00','2020-12-17 00:00:00','FAY040','première donnée'),
(27,'2021-09-20 00:00:00','2021-09-20 00:00:00','MVP860','première donnée'),
(28,'2019-09-26 00:00:00','2019-09-26 00:00:00','BP130','première donnée'),
(29,'2019-02-05 00:00:00','2019-02-05 00:00:00','ELH675','première donnée'),
(30,'2019-08-09 00:00:00','2019-08-09 00:00:00','MTG320','première donnée'),
(31,'2020-08-11 00:00:00','2020-08-11 00:00:00','BOMU1610','première donnée'),
(32,'2017-03-04 00:00:00','2017-03-04 00:00:00','TBL105','première donnée'),
(33,'2017-03-09 00:00:00','2017-03-09 00:00:00','GDC030','première donnée'),
(34,'2023-12-11 00:00:00','2023-12-11 00:00:00','MTG280','première donnée'),
(35,'2022-02-10 00:00:00','2022-02-10 00:00:00','MAT315','première donnée'),
(36,'2019-09-26 00:00:00','2019-09-26 00:00:00','PSL310','première donnée'),
(37,'2017-12-11 00:00:00','2017-12-11 00:00:00','SPC010','première donnée'),
(38,'2014-12-31 00:00:00','2014-12-31 00:00:00','BRT240','première donnée'),
(39,'2016-10-20 00:00:00','2016-10-20 00:00:00','TRG170','première donnée'),
(40,'2021-04-22 00:00:00','2021-04-22 00:00:00','ROQ070','première donnée'),
(41,'2021-01-22 00:00:00','2021-01-22 00:00:00','CAM015','première donnée'),
(42,'2019-06-05 00:00:00','2019-06-05 00:00:00','LAN030','première donnée'),
(43,'2019-11-16 00:00:00','2019-11-16 00:00:00','PAH575','première donnée'),
(44,'2024-01-12 00:00:00','2024-01-17 00:00:00','Belal','système')
;
-- reset id serial to max id
SELECT SETVAL('annotations_id_seq', (SELECT MAX(id) FROM annotations));

-- display number of inserted rows
select 'nb postes: ' || count(*) from postes;
select 'nb mesures: ' || count(*) from mesures;
select 'nb annotations: ' || count(*) from annotations;

-- get last values
-- select poste_id, name, last(date_local, mesure_id), last(avg, mesure_id)  from obs_month join mesures on mesures.id = mesure_id group by 1,2 order by 1,2;
create materialized view obs_hour WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 hour', o.date_local, origin => '1950-01-01') as date_local,
        o.poste_id as poste_id,
        o.mesure_id as mesure_id,
        m.is_avg as is_avg,
        sum(o.duration) as duration,
        CASE WHEN m.is_avg is True THEN avg(o.value) ELSE sum(o.value) END AS value
  from obs o join mesures m on m.id = mesure_id
  where qa_value != 9 and duration <= 60
  group by 1,2,3,4;

ALTER MATERIALIZED VIEW obs_hour set (timescaledb.materialized_only = false);

SELECT add_continuous_aggregate_policy('obs_hour',
  start_offset => INTERVAL '60 minute',
  end_offset => NULL,
  schedule_interval => INTERVAL '30 minutes');

create materialized view obs_day WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 day', o.date_local, origin => '1950-01-01') as date_local,
        o.poste_id as poste_id,
        o.mesure_id as mesure_id,
        m.is_avg as is_avg,
        sum(o.duration) as duration,
        CASE WHEN m.is_avg is True THEN avg(o.value) ELSE sum(o.value) END AS value
  from obs o join mesures m on m.id = mesure_id
  where qa_value != 9
  group by 1,2,3,4;


ALTER MATERIALIZED VIEW obs_day set (timescaledb.materialized_only = false);

SELECT add_continuous_aggregate_policy('obs_day',
  start_offset => INTERVAL '60 minute',
  end_offset => NULL,
  schedule_interval => INTERVAL '30 minutes');


create materialized view obs_month WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 month', o.date_local, origin => '1950-01-01') as date_local,
        o.poste_id,
        o.mesure_id,
        m.is_avg as is_avg,
        sum(o.duration) as duration,
        CASE WHEN m.is_avg is True THEN avg(o.value) ELSE sum(o.value) END AS value
  from obs_day o join mesures m on m.id = mesure_id
  group by 1,2,3,4;


ALTER MATERIALIZED VIEW obs_month set (timescaledb.materialized_only = false);

SELECT add_continuous_aggregate_policy('obs_month',
  start_offset => INTERVAL '2 days',
  end_offset => NULL,
  schedule_interval => INTERVAL '1 day');

create materialized view x_min_day WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 day', date_local, origin => '1950-01-01') as date_local,
        poste_id as poste_id,
        mesure_id as mesure_id,
        CASE WHEN m.is_avg is True THEN min(x_min.min) ELSE sum(x_min.min) END AS min,
        first(x_min.min_time, x_min.min) as min_time
  from x_min join mesures m on m.id = mesure_id
  where qa_min != 9
  group by 1,2,3, m.is_avg;


ALTER MATERIALIZED VIEW x_min_day set (timescaledb.materialized_only = false);

SELECT add_continuous_aggregate_policy('x_min_day',
  start_offset => INTERVAL '12 hours',
  end_offset => NULL,
  schedule_interval => INTERVAL '6 hours');


create materialized view x_min_month WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 month', date_local, origin => '1950-01-01') as date_local,
        poste_id as poste_id,
        mesure_id as mesure_id,
        CASE WHEN m.is_avg is True THEN min(x_min_day.min) ELSE sum(x_min_day.min) END AS min,
        first(x_min_day.min_time, x_min_day.min) as min_time
  from x_min_day join mesures m on m.id = mesure_id
 group by 1,2,3, m.is_avg;

ALTER MATERIALIZED VIEW x_min_month set (timescaledb.materialized_only = false);

SELECT add_continuous_aggregate_policy('x_min_month',
  start_offset => INTERVAL '2 days',
  end_offset => NULL,
  schedule_interval => INTERVAL '1 day');

create materialized view x_max_day WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 day', date_local, origin => '1950-01-01') as date_local,
        poste_id as poste_id,
        mesure_id as mesure_id,
        CASE WHEN m.is_avg is True THEN max(x_max.max) ELSE sum(x_max.max) END AS max,
        last(x_max.max_time, x_max.max) as max_time,
        last(x_max.max_dir, x_max.max) as max_dir
  from x_max join mesures m on m.id = mesure_id
  where qa_max != 9
  group by 1,2,3, m.is_avg;

ALTER MATERIALIZED VIEW x_max_day set (timescaledb.materialized_only = false);

SELECT add_continuous_aggregate_policy('x_max_day',
  start_offset => INTERVAL '12 hours',
  end_offset => NULL,
  schedule_interval => INTERVAL '6 hours');

create materialized view x_max_month WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 month', date_local, origin => '1950-01-01') as date_local,
        poste_id as poste_id,
        mesure_id as mesure_id,
        CASE WHEN m.is_avg is True THEN max(x_max_day.max) ELSE sum(x_max_day.max) END AS max,
        last(x_max_day.max_time, x_max_day.max) as max_time,
        last(x_max_day.max_dir, x_max_day.max) as max_dir
  from x_max_day join mesures m on m.id = mesure_id
  group by 1,2,3, m.is_avg;

ALTER MATERIALIZED VIEW x_max_month set (timescaledb.materialized_only = false);

SELECT add_continuous_aggregate_policy('x_max_month',
  start_offset => INTERVAL '2 days',
  end_offset => NULL,
  schedule_interval => INTERVAL '1 day');

CREATE OR REPLACE PROCEDURE refresh_all_aggregates()
LANGUAGE plpgsql
AS $$
BEGIN
  CALL refresh_continuous_aggregate('obs_hour', null, null);
  CALL refresh_continuous_aggregate('obs_day', null, null);
  CALL refresh_continuous_aggregate('obs_month', null, null);
  CALL refresh_continuous_aggregate('x_min_day', null, null);
  CALL refresh_continuous_aggregate('x_min_month', null, null);
  CALL refresh_continuous_aggregate('x_max_day', null, null);
  CALL refresh_continuous_aggregate('x_max_month', null, null);
END; $$;

-- create materialized view compare_month WITH (timescaledb.continuous) as
-- materialized view does not support left join...

--  select
--         timescaledb_experimental.time_bucket_ng('1 month', o.date_local, origin => '1950-01-01') as date_local,
--         o.poste_id,
--         avg(o.value) as avg_value,
--         min(mi.min),
--         first(mi.min_time, mi.min) as min_time,
--         max(ma.max),
--         last(ma.max_time, ma.max) as max_time
--     from obs_month o 
--       left join x_min_month mi on 
--         o.poste_id = mi.poste_id
--         and o.mesure_id = mi.mesure_id
--         and timescaledb_experimental.time_bucket_ng('1 month', mi.date_local, origin => '1950-01-01') = timescaledb_experimental.time_bucket_ng('1 month', mi.date_local, origin => '1950-01-01')
--       left join x_max_month ma on 
--         o.poste_id = ma.poste_id
--         and o.mesure_id = ma.mesure_id
--         and timescaledb_experimental.time_bucket_ng('1 month', ma.date_local, origin => '1950-01-01') = timescaledb_experimental.time_bucket_ng('1 month', ma.date_local, origin => '1950-01-01')
--     where o.mesure_id = 1
-- --       Important to add a where on each table => 
-- --           timescale can limit the search in the underlying chunks for each table
--       and o.date_local > '202-12-01'
--       and mi.date_local > '202-12-01'
--       and ma.date_local > '202-12-01'
--     group by 1,2;

-- ---------
-- Triggers
-- ---------
/*
*  maintain last_obs_date/id in poste table
*  cascade qa_value to x_min/x_max tables
*/ 
CREATE OR REPLACE FUNCTION create_update_obs_trigger_fn()
  RETURNS TRIGGER LANGUAGE PLPGSQL AS
$BODY$
DECLARE
    obs_dat timestamp;
    last_obs_dat timestamp;
BEGIN
  select last_obs_date  into obs_dat from postes where id = NEW.poste_id;
  if obs_dat is null or new.date_local > obs_dat then
    update postes set last_obs_date = NEW.date_local, last_obs_id = NEW.id where id = NEW.poste_id;
  end if;
  if NEW.qa_value <> OLD.qa_value then
    update x_min set qa_min = NEW.qa_value where obs_id = NEW.id;
    update x_max set qa_max = NEW.qa_value where obs_id = NEW.id;
  end if;

  -- Update last_obs
  select date_local from last_obs where poste_id = NEW.poste_id and mesure_id = NEW.mesure_id into last_obs_dat;
  if obs_dat is null then
    insert into last_obs (poste_id, mesure_id, date_local, value) values (NEW.poste_id, NEW.mesure_id, NEW.date_local, NEW.value);
  elsif last_obs_dat < NEW.date_local then
    update last_obs set date_local = NEW.date_local, value = NEW.value where poste_id = NEW.poste_id and mesure_id = NEW.mesure_id;
  end if;

  return NEW;
END
$BODY$;

CREATE OR REPLACE TRIGGER create_update_obs_trigger
  AFTER INSERT OR UPDATE ON obs
  FOR EACH ROW EXECUTE PROCEDURE create_update_obs_trigger_fn();

/*
*  cascade delete obs to x_min/x_max
*/ 
CREATE OR REPLACE FUNCTION delete_obs_trigger_fn()
  RETURNS TRIGGER LANGUAGE PLPGSQL AS
$BODY$
DECLARE
BEGIN
    delete from x_min where obs_id = OLD.id;
    delete from x_max where obs_id = OLD.id;
  return OLD;
END
$BODY$;

CREATE OR REPLACE TRIGGER delete_obs_trigger
  AFTER INSERT OR UPDATE ON x_max
  FOR EACH ROW EXECUTE PROCEDURE delete_obs_trigger_fn();


-- CREATE OR REPLACE FUNCTION get_last_obs(pid integer)
-- RETURNS TABLE(poste_id smallint, ) LANGUAGE plpgsql
-- AS $$
-- DECLARE
--   select last(date_local, mesure_id) as date_local, last(avg, mesure_id) as mesure_id
--     from obs_month join mesures on mesures.id = mesure_id
--     where poste_id = pid
--     group by 1,2
--     order by 1,2;
-- END;
-- $$
-- ;

/*
Id_station;Id_omm;Nom_usuel;Latitude;Longitude;Altitude;Date_ouverture;Pack
97401520;;LE TEVELAVE;-21.211667;55.361333;908;1953-01-01;ETENDU
97401540;;LES AVIRONS - CIRAD;-21.239500;55.327500;180;1952-01-01;ETENDU
97402240;;BELLEVUE BRAS-PANON;-21.005000;55.622667;480;1990-09-01;RADOME
97403410;;LE DIMITILE_SAPC;-21.189000;55.481500;1808;2013-09-27;ETENDU
97403435;;BRAS-LONG_SAPC;-21.228333;55.474667;510;2013-05-22;ETENDU
97404540;;PONT-MATHURIN;-21.265000;55.380000;19;1961-06-01;RADOME
97405420;;PITON-BLOC_SAPC;-21.321167;55.572333;812;1990-01-01;ETENDU
97406220;;PLAINE DES PALMISTES;-21.136167;55.627167;1032;1952-01-01;RADOME
97407520;61981;LE PORT;-20.946167;55.282000;9;1971-04-18;RADOME
97408510;;POSSESSION;-20.921333;55.346167;9;1997-10-01;ETENDU
97408560;;AURERE_SAPC;-21.018833;55.424833;940;1952-01-01;ETENDU
97408580;;LA NOUVELLE_SAPC;-21.076667;55.423333;1415;1970-01-01;ETENDU
97408582;;DOS D'ANE;-20.978500;55.390500;1027;2022-05-02;ETENDU
97409210;;BOIS-ROUGE;-20.913667;55.641333;5;1952-01-01;ETENDU
97409230;;LE COLOSSE;-20.934500;55.664500;16;1957-03-01;RADOME
97409240;;MENCIOL;-20.961167;55.625667;181;1953-01-01;ETENDU
97410202;;BEAUVALLON;-21.008000;55.693333;16;1952-01-01;ETENDU
97410238;;SAINT-BENOIT;-21.058833;55.719333;43;1952-01-01;RADOME
97410250;;TAKAMAKA - PK12_SAPC;-21.076333;55.630833;660;1971-11-01;ETENDU
97410265;;CHEMIN DE CEINTURE_SAPC;-21.076333;55.685500;255;2003-07-24;ETENDU
97411132;;CHAUDRON;-20.897000;55.495000;38;1967-01-01;ETENDU
97411141;;GRANDE-CHALOUPE;-20.898333;55.369833;10;1997-10-01;ETENDU
97411146;;COLORADO_SAPC;-20.910500;55.421500;702;2003-02-26;ETENDU
97411150;;SAINT-FRANCOIS;-20.921333;55.456333;545;1953-03-01;ETENDU
97411155;;MONTAUBAN_SAPC;-20.938667;55.496833;420;2009-09-29;ETENDU
97411164;;LE BRULE - VAL FLEURI_SAPC;-20.941667;55.429500;1069;1956-09-01;ETENDU
97411170;;PLAINE DES CHICOTS_SAPC;-20.987333;55.444833;1834;1982-01-01;ETENDU
97412302;;COMMERSON_SAPC;-21.208000;55.643667;2310;1968-01-01;ETENDU
97412336;;GRAND-COUDE_SAPC;-21.301667;55.631333;1085;1978-01-01;ETENDU
97412340;;GRAND-GALET;-21.311000;55.639500;505;1953-08-06;ETENDU
97412356;;LA CRETE_SAPC;-21.337500;55.667667;659;1968-10-01;ETENDU
97412384;;ST-JOSEPH_SAPC;-21.385167;55.609667;13;1960-04-01;ETENDU
97412801;;ST JOSEPH-CIRAD;-21.385167;55.609667;13;2021-10-05;ETENDU
97413520;;COLIMACONS;-21.130333;55.304667;798;1963-08-01;RADOME
97413542;;ST-LEU;-21.190000;55.292333;79;1950-10-01;ETENDU
97413545;;SAINT-LEU - CIRAD;-21.187333;55.300833;222;1997-01-01;ETENDU
97413550;;ETANG SAINT-LEU - CIRAD;-21.173333;55.308833;429;2002-02-01;ETENDU
97413580;;PITON SAINT-LEU_SAPC;-21.215167;55.325833;530;1973-02-01;ETENDU
97414409;;PLAINE DES MAKES_SAPC;-21.199500;55.409167;980;2004-12-29;ETENDU
97414431;;LE GOL LES HAUTS - CIRAD;-21.245833;55.428000;365;1997-01-01;ETENDU
97414451;;LE TAPAGE - CIRAD;-21.224667;55.444167;863;2002-03-25;ETENDU
97415516;;BOIS DE NEFLES ST-PAUL_SAPC;-20.997500;55.341167;595;1952-01-01;ETENDU
97415536;;PETITE-FRANCE;-21.045000;55.342000;1200;1999-09-01;RADOME
97415541;;TAN-ROUGE_SAPC;-21.069167;55.299667;750;1960-01-01;ETENDU
97415550;;L'ERMITAGE - CIRAD;-21.053000;55.241333;147;2002-05-01;ETENDU
97415557;;LE GUILLAUME;-21.064667;55.324333;1035;1953-01-01;ETENDU
97415566;;PITON-MAIDO;-21.076667;55.381167;2150;1998-11-18;RADOME
97415590;;POINTE DES TROIS-BASSINS;-21.105167;55.247667;5;1987-10-02;RADOME
97415592;;TAN ROUGE-CIRAD;-21.069167;55.299667;746;2021-06-02;ETENDU
97416410;;RAVINE DES CABRIS - CIRAD;-21.274500;55.475333;310;1997-01-01;ETENDU
97416463;;PIERREFONDS-AEROPORT;-21.320000;55.425500;21;1999-01-01;RADOME
97416465;;LIGNE-PARADIS - CIRAD;-21.319167;55.485167;156;1966-01-01;ETENDU
97417340;;LE TREMBLET;-21.317333;55.801000;91;1953-01-01;ETENDU
97417360;;LE BARIL;-21.359000;55.732167;114;1989-02-01;RADOME
97418110;61980;GILLOT-AEROPORT;-20.892167;55.528667;8;1953-01-01;RADOME
97418123;;LA MARE - CIRAD;-20.903500;55.532000;68;2001-01-01;ETENDU
97418170;;PLAINE DES FOUGERES_SAPC;-20.967333;55.527833;1064;1993-06-01;ETENDU
97419310;;RIVIERE DE L'EST - CIRAD;-21.120167;55.758667;144;1953-01-01;ETENDU
97419320;;HAUTS DE SAINTE-ROSE_SAPC;-21.159500;55.763667;820;1973-07-01;ETENDU
97419350;;GROS PITON SAINTE-ROSE;-21.179500;55.828833;181;1987-09-01;RADOME
97419380;;BELLECOMBE-JACOB;-21.217833;55.687000;2245;1966-11-01;RADOME
97420110;;GRAND-HAZIER - CIRAD;-20.902833;55.586000;69;1953-01-01;ETENDU
97420150;;BAGATELLE_SAPC;-20.931000;55.576667;262;1953-01-01;ETENDU
97420180;;BRAS-PISTOLET_SAPC;-20.969000;55.587500;556;2002-12-01;ETENDU
97421210;;MARE A VIEILLE PLACE;-21.027833;55.512167;870;1989-07-01;ETENDU
97421220;;GRAND-ILET_SAPC;-21.028667;55.471667;1185;1973-07-01;ETENDU
97421240;;SALAZIE-VILLAGE_SAPC;-21.031667;55.538500;476;1996-01-01;ETENDU
97421260;;BELOUVE_SAPC;-21.060833;55.536500;1500;1955-09-01;ETENDU
97421265;;ILET A VIDOT_SAPC;-21.063167;55.510333;940;2003-12-01;ETENDU
97422440;;PLAINE DES CAFRES;-21.209167;55.572833;1560;1948-01-01;RADOME
97422445;;BRAS-SEC;-21.205667;55.525167;1210;1969-11-15;ETENDU
97422455;;PONT D'YVES;-21.231333;55.503167;835;1977-07-19;ETENDU
97422465;;LE TAMPON - CIRAD;-21.251667;55.530333;860;1958-01-01;ETENDU
97424410;;CILAOS;-21.134167;55.471667;1197;1952-01-01;RADOME
97424450;;ILET A CORDES_SAPC;-21.153500;55.438167;1067;1977-08-08;ETENDU
97424460;;PALMISTE-ROUGE;-21.168667;55.474500;830;1962-01-01;ETENDU
*/