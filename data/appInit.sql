-- Station du reseau meteor
insert into postes
(meteor, delta_timezone, data_source, type, owner, email, phone, quartier, city, country, altitude, lat, long, load_type) values
('BAG280',   4, 0, 'VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  280, 0, 0, 1),
('BBF015',   4, 0, 'VP2', 'Micolas Cuvillier', 'micka@meteor-oi.re', '0612345678', 'Bain Boeuf', 'Bain boeuf', 'Maurice',  15,  -20.933387, 55.582768, 1),
('BDN240',   4, 0, 'VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  240, 0, 0, 1),
('BER590',   4, 0, 'VP2', 'Sabine/Pierre', 'micka@meteor-oi.re', '0612345678', 'Bérive 590', 'Le Tampon', 'la réunion',  590, -21.309871, 55.537723, 1),
('BER605',   4, 0, 'VP2', 'Véronique', 'micka@meteor-oi.re', '0612345678', 'Bérive 605', 'Le Tampon', 'la réunion',  605, -21.30833, 55.53887, 1),
('BOCO1370', 4, 0, 'VP2', 'Donny', 'micka@meteor-oi.re', '0612345678', 'Bois court', 'Le Tampon', 'la réunion',  1370,  -21.196061, 55.53827, 1),
('BOMU1610', 4, 0, 'VP2', 'Patrice', 'micka@meteor-oi.re', '0612345678', 'Bourg Murat', 'Le Tampon', 'la réunion',  1600, -21.192665, 55.576251, 1),
('BP130',    4, 0, 'VP2', 'Alexandre Nativel', 'micka@meteor-oi.re', '0612345678', 'Bassin Plat', 'Saint Pierre', 'la réunion',  135, -21.330492, 55.489393, 1),
('BPN100',   4, 0, 'VP2', 'Ami de Jack Quillet', 'micka@meteor-oi.re', '0612345678', 'La caroline', 'Bras Panon', 'la réunion',  100, -21.002163, 55.652502, 1),
('BRL030',   4, 0, 'VP2', 'Geoffroy', 'micka@meteor-oi.re', '0612345678', 'Baril', 'Saint Philippe', 'la réunion',  80, -21.362132, 55.725414, 1),
('BRT155',   4, 0, 'VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'La Bretagne', 'Saint Denis', 'la réunion',  155, -20.912244, 55.493962, 1),
('BRT240',   4, 0, 'VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  240,  0, 0, 1),
('CAM015',   4, 0, 'VP2', 'Entreprise Drone', 'micka@meteor-oi.re', '0612345678', 'Cambaie', 'Saint Paul', 'la réunion',  20, -20.961875, 55.282956, 1),
('CBG270',   4, 0, 'VP2', 'Tony', 'micka@meteor-oi.re', '0612345678', 'Cambourg', 'Saint Benoit', 'la réunion',  260, -21.113488, 55.728536, 1),
('CHAR645',  4, 0, 'VP2', 'Frederik/Caroline', 'micka@meteor-oi.re', '0612345678', 'Charrié', 'Petite Ile', 'la réunion',  645, -21.192665, 55.576251, 1),
('CHP690',   4, 0, 'Vue', 'Thiébaut', 'micka@meteor-oi.re', '0612345678', 'La Chapelle/†evelave', 'Les Avirons', 'la réunion', 6900, -21.220226, 55.344443, 1),
('CRT630',   4, 0, 'Vue', 'Micka', 'micka@meteor-oi.re', '0612345678', 'La Crete 1', 'Saint Joseph', 'la réunion',  630,  -21.335742, 55.656652, 1),
('CRT635',   4, 0, 'Vue', 'Micka', 'micka@meteor-oi.re', '0612345678', 'La Crete 2', 'Saint Joseph', 'la réunion',  635,  -21.340014, 55.667172, 1),
('CUP575',   4, 0, 'Vue', 'Vishal', 'micka@meteor-oi.re', '0612345678', 'Curepipe', 'Curepipe', 'Maurice',  575,   -20.933387, 55.582768, 1),
('ELH675',   4, 0, 'Vue', 'Mat/Actus Meteo 974', 'micka@meteor-oi.re', '0612345678', 'Esperance les hauts', 'Saint Marie', 'la réunion',  670,  -20.950965, 55.516872, 1),
('ESB005',   4, 0, 'VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Etang Salé les Bains', 'Etang Salé', 'la réunion',  10, -21.26778775, 55.335363, 1),
('ESH555',   4, 0, 'VP2', 'Laurent', 'micka@meteor-oi.re', '0612345678', 'Etang Salé', 'Etang Salé', 'la réunion',  555, -21.236787, 55.378695, 1),
('FAY040',   4, 0, 'VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  40, -20.941706, 55.65897, 1),
('GDC030',   4, 0, 'VP2', 'Sébastien Langlade', 'micka@meteor-oi.re', '0612345678', 'Grand Canal', 'Saint André', 'la réunion',  27, -20.95888, 55.689574, 1),
('GFD010',   4, 0, 'VP2', 'Thierry François', 'micka@meteor-oi.re', '0612345678', 'Grand Fond', 'Saint Paul', 'la réunion',  10, -21.26778775, 55.219428, 1),
('LAN030',   4, 0, 'VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Langevin', 'Saint Joseph', 'la réunion',  40,  -21.384245, 55.647383, 1),
('LCV050',   4, 0, 'VP2', 'Philippe', 'micka@meteor-oi.re', '0612345678', 'La Convenance', 'Sainte Marie', 'la réunion',  45,  -20.895952, 55.572072, 1),
('MAK805',   4, 0, 'VP2', 'Jimmy', 'micka@meteor-oi.re', '0612345678', 'Les Makes', 'Saint Louis', 'la réunion',  800, -21.217226, 55.405008, 1),
('MAT315',   4, 0, 'VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Matouta', 'Saint Joseph', 'la réunion',  315, -21.360229, 55.70152, 1),
('MDM1570',  4, 0, 'VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Marla', 'Saint Paul', 'la réunion',  1570, -21.100918, 55.430022, 1),
('MTG280',   4, 0, 'VP2', 'Fréderic Caillé', 'micka@meteor-oi.re', '0612345678', 'La Montagne', 'Saint Denis', 'la réunion',  260, -20.878348, 55.428241, 1),
('MTG320',   4, 0, 'VP2', 'Hubert', 'micka@meteor-oi.re', '0612345678', 'La Montagne', 'Saint Denis', 'la réunion',  320, -20.882, 55.424667, 1),
('MVP860',   4, 0, 'VP2', 'Jack Quillet', 'micka@meteor-oi.re', '0612345678', 'Mare à Vieille Place', 'Salazie', 'la réunion',  860, -21.025844, 55.515549, 1),
('NDLP1520', 4, 0, 'VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Nogtre Dame de la Paix', 'Le Tampon', 'la réunion',  1520, -21.250525, 55.584708, 1),
('PAH575',   4, 0, 'VP2', 'Association', 'micka@meteor-oi.re', '0612345678', 'Piton Armand les Hauts', 'Saint Benoit', 'la réunion',  575,  -21.122265, 55.703658, 1),
('PFD040',   4, 0, 'VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  40,  -21.300325, 55.418679, 1),
('PSL310',   4, 0, 'VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  310,  -21.300325, 55.418679, 1),
('RAM450',   4, 0, 'VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  450,  -20.928899, 55.365116, 1),
('ROQ070',   4, 0, 'Vue', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  70, -21.059036, 55.229183, 1),
('SPC010',   4, 0, 'Vue', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  10, -21.053141, 55.695668, 1),
('SBBM100',  4, 0, 'VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  100, -21.053141, 55.695668, 1),
('TAM1790',  4, 0, 'VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  1790,  -21.106126, 55.362666, 1),
('TAN1270',  4, 0, 'VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  1270,  -21.106126, 55.362666, 1),
('TAR600',   4, 0, 'VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  600,  -21.059972, 55.289673, 1),
('TBL105',   4, 0, 'VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  105, -21.317372, 55.800674, 1),
('TRG170',   4, 0, 'VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  170, -21.338827, 55.51276, 1),
('TRM490',   4, 0, 'VP2', 'Micka', 'micka@meteor-oi.re', '0612345678', 'quartier', 'Commune', 'la réunion',  490, -21.26666, 55.495548, 1)
;

-- Stations meteoFR (extrait de DH.RUN.2024.04.18.11.txt.html)
insert into postes
(meteor, delta_timezone, data_source, other_code, type, owner, email, phone, quartier, city, country, altitude, lat, long, load_type) values
('LE TEVELAVE', 4, 1, '97401520', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'LE TEVELAVE', 'LE TEVELAVE', 'la réunion', 908, 21.21166667, 55.36111111, 8),
('LES AVIRONS-CIRAD', 4, 1, '97401540', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'LES AVIRONS-CIRAD', 'LES AVIRONS-CIRAD', 'la réunion', 180, 21.23944444, 55.3275, 8),
('BELLEVUE BRAS-PANON', 4, 1, '97402240', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'BELLEVUE BRAS-PANON', 'BELLEVUE BRAS-PANON', 'la réunion', 480, 21.00472222, 55.6225, 8),
('LE DIMITILE_SAPC', 4, 1, '97403410', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'LE DIMITILE_SAPC', 'LE DIMITILE_SAPC', 'la réunion', 1808, 21.18888889, 55.48138889, 8),
('BRAS-LONG_SAPC', 4, 1, '97403435', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'BRAS-LONG_SAPC', 'BRAS-LONG_SAPC', 'la réunion', 510, 21.22805556, 55.47444444, 8),
('PONT-MATHURIN', 4, 1, '97404540', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'PONT-MATHURIN', 'PONT-MATHURIN', 'la réunion', 19, 21.265, 55.38, 8),
('PITON-BLOC_SAPC', 4, 1, '97405420', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'PITON-BLOC_SAPC', 'PITON-BLOC_SAPC', 'la réunion', 812, 21.32111111, 55.57222222, 8),
('PLAINE DES PALMISTES', 4, 1, '97406220', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'PLAINE DES PALMISTES', 'PLAINE DES PALMISTES', 'la réunion', 1032, 21.13611111, 55.62694444, 8),
('LE PORT', 4, 1, '97407520', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'LE PORT', 'LE PORT', 'la réunion', 9, 20.94611111, 55.28194444, 8),
('POSSESSION', 4, 1, '97408510', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'POSSESSION', 'POSSESSION', 'la réunion', 9, 20.92111111, 55.34611111, 8),
('POSSESSION-P2', 4, 1, '97408511', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'POSSESSION-P2', 'POSSESSION-P2', 'la réunion', 9, 20.92111111, 55.34611111, 8),
('AURERE_SAPC', 4, 1, '97408560', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'AURERE_SAPC', 'AURERE_SAPC', 'la réunion', 940, 21.01861111, 55.42472222, 8),
('LA NOUVELLE_SAPC', 4, 1, '97408580', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'LA NOUVELLE_SAPC', 'LA NOUVELLE_SAPC', 'la réunion', 1415, 21.07666667, 55.42305556, 8),
('DOS D ANE', 4, 1, '97408582', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'DOS D ANE', 'DOS D ANE', 'la réunion', 1027, 20.97833333, 55.39027778, 8),
('BOIS-ROUGE', 4, 1, '97409210', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'BOIS-ROUGE', 'BOIS-ROUGE', 'la réunion', 5, 20.91361111, 55.64111111, 8),
('MENCIOL', 4, 1, '97409240', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'MENCIOL', 'MENCIOL', 'la réunion', 181, 20.96111111, 55.62555556, 8),
('BEAUVALLON', 4, 1, '97410202', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'BEAUVALLON', 'BEAUVALLON', 'la réunion', 16, 21.00777778, 55.69305556, 8),
('SAINT-BENOIT', 4, 1, '97410238', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'SAINT-BENOIT', 'SAINT-BENOIT', 'la réunion', 43, 21.05861111, 55.71916667, 8),
('TAKAMAKA-PK12_SAPC', 4, 1, '97410250', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'TAKAMAKA-PK12_SAPC', 'TAKAMAKA-PK12_SAPC', 'la réunion', 660, 21.07611111, 55.63055556, 8),
('CHEMIN DE CEINTURE_SAPC', 4, 1, '97410265', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'CHEMIN DE CEINTURE_SAPC', 'CHEMIN DE CEINTURE_SAPC', 'la réunion', 255, 21.07611111, 55.68527778, 8),
('CHAUDRON', 4, 1, '97411132', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'CHAUDRON', 'CHAUDRON', 'la réunion', 38, 20.89694444, 55.49472222, 8),
('GRANDE-CHALOUPE', 4, 1, '97411141', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'GRANDE-CHALOUPE', 'GRANDE-CHALOUPE', 'la réunion', 10, 20.89805556, 55.36972222, 8),
('GRANDE-CHALOUPE-P2', 4, 1, '97411142', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'GRANDE-CHALOUPE-P2', 'GRANDE-CHALOUPE-P2', 'la réunion', 7, 20.89777778, 55.375, 8),
('COLORADO_SAPC', 4, 1, '97411146', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'COLORADO_SAPC', 'COLORADO_SAPC', 'la réunion', 702, 20.91027778, 55.42138889, 8),
('SAINT-FRANCOIS', 4, 1, '97411150', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'SAINT-FRANCOIS', 'SAINT-FRANCOIS', 'la réunion', 545, 20.92111111, 55.45611111, 8),
('MONTAUBAN_SAPC', 4, 1, '97411155', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'MONTAUBAN_SAPC', 'MONTAUBAN_SAPC', 'la réunion', 420, 20.93861111, 55.49666667, 8),
('LE BRULE-VAL FLEURI_SAPC', 4, 1, '97411164', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'LE BRULE-VAL FLEURI_SAPC', 'LE BRULE-VAL FLEURI_SAPC', 'la réunion', 1069, 20.94166667, 55.42944444, 8),
('PLAINE DES CHICOTS_SAPC', 4, 1, '97411170', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'PLAINE DES CHICOTS_SAPC', 'PLAINE DES CHICOTS_SAPC', 'la réunion', 1834, 20.98722222, 55.44472222, 8),
('COMMERSON_SAPC', 4, 1, '97412302', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'COMMERSON_SAPC', 'COMMERSON_SAPC', 'la réunion', 2310, 21.20777778, 55.64361111, 8),
('GRAND-COUDE_SAPC', 4, 1, '97412336', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'GRAND-COUDE_SAPC', 'GRAND-COUDE_SAPC', 'la réunion', 1085, 21.30166667, 55.63111111, 8),
('GRAND-GALET', 4, 1, '97412340', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'GRAND-GALET', 'GRAND-GALET', 'la réunion', 505, 21.31083333, 55.63944444, 8),
('LA CRETE_SAPC', 4, 1, '97412356', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'LA CRETE_SAPC', 'LA CRETE_SAPC', 'la réunion', 659, 21.33722222, 55.6675, 8),
('ST-JOSEPH_SAPC', 4, 1, '97412384', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'ST-JOSEPH_SAPC', 'ST-JOSEPH_SAPC', 'la réunion', 13, 21.385, 55.60944444, 8),
('COLIMACONS', 4, 1, '97413520', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'COLIMACONS', 'COLIMACONS', 'la réunion', 798, 21.13027778, 55.30444444, 8),
('ST-LEU', 4, 1, '97413542', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'ST-LEU', 'ST-LEU', 'la réunion', 79, 21.19, 55.29222222, 8),
('PITON SAINT-LEU_SAPC', 4, 1, '97413580', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'PITON SAINT-LEU_SAPC', 'PITON SAINT-LEU_SAPC', 'la réunion', 530, 21.215, 55.32555556, 8),
('PLAINE DES MAKES_SAPC', 4, 1, '97414409', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'PLAINE DES MAKES_SAPC', 'PLAINE DES MAKES_SAPC', 'la réunion', 980, 21.19944444, 55.40916667, 8),
('LE TAPAGE-CIRAD', 4, 1, '97414451', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'LE TAPAGE-CIRAD', 'LE TAPAGE-CIRAD', 'la réunion', 863, 21.22444444, 55.44416667, 8),
('SAINT-PAUL-CIRAD', 4, 1, '97415511', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'SAINT-PAUL-CIRAD', 'SAINT-PAUL-CIRAD', 'la réunion', 186, 20.97527778, 55.325, 8),
('BOIS DE NEFLES ST-PAUL_SAPC', 4, 1, '97415516', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'BOIS DE NEFLES ST-PAUL_SAPC', 'BOIS DE NEFLES ST-PAUL_SAPC', 'la réunion', 595, 20.99722222, 55.34111111, 8),
('PETITE-FRANCE', 4, 1, '97415536', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'PETITE-FRANCE', 'PETITE-FRANCE', 'la réunion', 1200, 21.045, 55.34194444, 8),
('TAN-ROUGE_SAPC', 4, 1, '97415541', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'TAN-ROUGE_SAPC', 'TAN-ROUGE_SAPC', 'la réunion', 750, 21.06916667, 55.29944444, 8),
('L ERMITAGE-CIRAD', 4, 1, '97415550', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'L ERMITAGE-CIRAD', 'L ERMITAGE-CIRAD', 'la réunion', 147, 21.05277778, 55.24111111, 8),
('LE GUILLAUME', 4, 1, '97415557', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'LE GUILLAUME', 'LE GUILLAUME', 'la réunion', 1035, 21.06444444, 55.32416667, 8),
('PITON-MAIDO', 4, 1, '97415566', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'PITON-MAIDO', 'PITON-MAIDO', 'la réunion', 2150, 21.07666667, 55.38111111, 8),
('VUE-BELLE LES HAUTS-CIRAD', 4, 1, '97415579', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'VUE-BELLE LES HAUTS-CIRAD', 'VUE-BELLE LES HAUTS-CIRAD', 'la réunion', 722, 21.08194444, 55.2925, 8),
('POINTE DES TROIS-BASSINS', 4, 1, '97415590', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'POINTE DES TROIS-BASSINS', 'POINTE DES TROIS-BASSINS', 'la réunion', 5, 21.105, 55.2475, 8),
('PIERREFONDS-AEROPORT', 4, 1, '97416463', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'PIERREFONDS-AEROPORT', 'PIERREFONDS-AEROPORT', 'la réunion', 21, 21.32, 55.42527778, 8),
('LIGNE-PARADIS-CIRAD', 4, 1, '97416465', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'LIGNE-PARADIS-CIRAD', 'LIGNE-PARADIS-CIRAD', 'la réunion', 156, 21.31916667, 55.485, 8),
('LE TREMBLET', 4, 1, '97417340', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'LE TREMBLET', 'LE TREMBLET', 'la réunion', 91, 21.31722222, 55.80083333, 8),
('LE BARIL', 4, 1, '97417360', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'LE BARIL', 'LE BARIL', 'la réunion', 114, 21.35888889, 55.73194444, 8),
('GILLOT-AEROPORT', 4, 1, '97418110', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'GILLOT-AEROPORT', 'GILLOT-AEROPORT', 'la réunion', 8, 20.89194444, 55.52861111, 8),
('LA MARE-CIRAD', 4, 1, '97418123', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'LA MARE-CIRAD', 'LA MARE-CIRAD', 'la réunion', 68, 20.90333333, 55.53194444, 8),
('PLAINE DES FOUGERES_SAPC', 4, 1, '97418170', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'PLAINE DES FOUGERES_SAPC', 'PLAINE DES FOUGERES_SAPC', 'la réunion', 1064, 20.96722222, 55.52777778, 8),
('RIVIERE DE L EST-CIRAD', 4, 1, '97419310', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'RIVIERE DE L EST-CIRAD', 'RIVIERE DE L EST-CIRAD', 'la réunion', 144, 21.12, 55.75861111, 8),
('HAUTS DE SAINTE-ROSE_SAPC', 4, 1, '97419320', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'HAUTS DE SAINTE-ROSE_SAPC', 'HAUTS DE SAINTE-ROSE_SAPC', 'la réunion', 820, 21.15944444, 55.76361111, 8),
('GROS PITON SAINTE-ROSE', 4, 1, '97419350', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'GROS PITON SAINTE-ROSE', 'GROS PITON SAINTE-ROSE', 'la réunion', 181, 21.17944444, 55.82861111, 8),
('BELLECOMBE-JACOB', 4, 1, '97419380', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'BELLECOMBE-JACOB', 'BELLECOMBE-JACOB', 'la réunion', 2245, 21.21777778, 55.68694444, 8),
('GRAND-HAZIER-CIRAD', 4, 1, '97420110', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'GRAND-HAZIER-CIRAD', 'GRAND-HAZIER-CIRAD', 'la réunion', 69, 20.90277778, 55.58583333, 8),
('BAGATELLE_SAPC', 4, 1, '97420150', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'BAGATELLE_SAPC', 'BAGATELLE_SAPC', 'la réunion', 262, 20.93083333, 55.57666667, 8),
('BRAS-PISTOLET_SAPC', 4, 1, '97420180', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'BRAS-PISTOLET_SAPC', 'BRAS-PISTOLET_SAPC', 'la réunion', 556, 20.96888889, 55.58722222, 8),
('MARE A VIEILLE PLACE', 4, 1, '97421210', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'MARE A VIEILLE PLACE', 'MARE A VIEILLE PLACE', 'la réunion', 870, 21.02777778, 55.51194444, 8),
('GRAND-ILET_SAPC', 4, 1, '97421220', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'GRAND-ILET_SAPC', 'GRAND-ILET_SAPC', 'la réunion', 1185, 21.02861111, 55.47166667, 8),
('SALAZIE-VILLAGE_SAPC', 4, 1, '97421240', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'SALAZIE-VILLAGE_SAPC', 'SALAZIE-VILLAGE_SAPC', 'la réunion', 476, 21.03166667, 55.53833333, 8),
('BELOUVE_SAPC', 4, 1, '97421260', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'BELOUVE_SAPC', 'BELOUVE_SAPC', 'la réunion', 1500, 21.06055556, 55.53638889, 8),
('ILET A VIDOT_SAPC', 4, 1, '97421265', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'ILET A VIDOT_SAPC', 'ILET A VIDOT_SAPC', 'la réunion', 940, 21.06305556, 55.51027778, 8),
('PLAINE DES CAFRES', 4, 1, '97422440', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'PLAINE DES CAFRES', 'PLAINE DES CAFRES', 'la réunion', 1560, 21.20916667, 55.57277778, 8),
('BRAS-SEC', 4, 1, '97422445', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'BRAS-SEC', 'BRAS-SEC', 'la réunion', 1210, 21.20555556, 55.525, 8),
('PONT D YVES', 4, 1, '97422455', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'PONT D YVES', 'PONT D YVES', 'la réunion', 835, 21.23111111, 55.50305556, 8),
('CILAOS', 4, 1, '97424410', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'CILAOS', 'CILAOS', 'la réunion', 1197, 21.13416667, 55.47166667, 8),
('ILET A CORDES_SAPC', 4, 1, '97424450', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'ILET A CORDES_SAPC', 'ILET A CORDES_SAPC', 'la réunion', 1067, 21.15333333, 55.43805556, 8),
('PALMISTE-ROUGE', 4, 1, '97424460', 'station meteoFR', 'Micka', 'micka@meteor-oi.re', '0612345678', 'PALMISTE-ROUGE', 'PALMISTE-ROUGE', 'la réunion', 830, 21.16861111, 55.47444444, 8)
;

-- Stations OVPF
insert into postes
(meteor, delta_timezone, data_source, other_code, type, owner, email, phone, quartier, city, country, altitude, lat, long, load_type) values
('FORX',   4, 3, 'Chateau Fort', 'pluvio ovpf', 'Micka', 'micka@meteor-oi.re', '0612345678', 'Volcan', 'Commune', 'la réunion', 2049, -21.26, 55.72, 16),
('SFRI',   4, 3, 'Soufriere', 'pluvio ovpf', 'Micka', 'micka@meteor-oi.re', '0612345678', 'Volcan', 'Commune', 'la réunion', 2530, -21.24, 55.71, 16),
('FERI',   4, 3, 'Flanc Est', 'pluvio ovpf', 'Micka', 'micka@meteor-oi.re', '0612345678', 'Volcan', 'Commune', 'la réunion', 1947, -21.24, 55.73, 16)
;

/*
  name:
  json_input: field name in json coming from weewx, and in Obs table
  archive_col: field name in weew archive database
  archive_table: table name when different than archive_col...
  field_dir: field for wind direction (not in omm measure)
  csv_field: column name in csv file
  csv_minmax: min/max in csv. Json with keys: min, minTime, max, maxTime, maxDir
  val_deca: decallage de la mesure OMM
  min: compute a min in extreme table
  min_deca: decallage du min OMM
  max: compute a max in extreme table
  max_deca: decallage du max OMM
  agreg_type: type agregation 0=None, 1=AVG, 2=SUM, 3=MAX, 4=MIN
  is_wind: is it a wind measure (need to find the winddir data)
  omm_link: for omm measure, link to the base measure
  allow_zero: not used...
  json_input_bis: ??
  is_houly: is data in json coming from weewx is a value for the full hour (etp)
*/

insert into mesures
(id,    name,            json_input,         archive_col,   archive_table, field_dir,    min,    max, agreg_type, is_wind, allow_zero, json_input_bis,   convert) values
( 1, 'barometer',       'barometer',        'barometer',         null,        null,     true,    false,    1,      false,    true,            null,        '{}'),
( 2, 'pressure',        'pressure',         'pressure',          null,        null,     false,   false,    1,      false,    true,            null,        '{}'),
(11, 'temp inside',     'in_temp',          'inTemp',            null,        null,     false,   false,    1,      false,    true,            null,        '{}'),
(12, 'temperature',     'out_temp',         'outTemp',           null,        null,     true,    true,     1,      false,    true,            null,        '{}'),
(13, 'dewpoint',        'dewpoint',         'dewpoint',          null,        null,     true,    true,     1,      false,    true,            null,        '{}'),
(14, 'etp',             'etp',              'ET',                null,        null,     false,   false,    0,      false,    true,            null,        '{}'),
(15, 'heatindex',       'heatindex',        'heatindex',         null,        null,     false,   false,    3,      false,    true,            null,        '{}'),
(16, 'extra_temp1',     'extra_temp1',      'extraTemp1',        null,        null,     false,   false,    1,      false,    true,      'extratemp1',      '{}'),
(17, 'extra_temp2',     'extra_temp2',      'extraTemp2',        null,        null,     false,   false,    1,      false,    true,      'extratemp2',      '{}'),
(18, 'extra_temp3',     'extra_temp3',      'extraTemp3',        null,        null,     false,   false,    1,      false,    true,      'extratemp3',      '{}'),
(30, 'humidity inside', 'in_humidity',      'inHumidity',        null,        null,     false,   false,    1,      false,    true,            null,        '{}'),
(31, 'humidity',        'out_humidity',     'outHumidity',       null,        null,     true,    true,     1,      false,    true,      'humidity',        '{}'),
(32, 'extrahumid1',     'extra_humid1',     'extraHumid1',       null,        null,     false,   false,    1,      false,    true,     'extrahumid1',      '{}'),
(33, 'extrahumid2',     'extra_humid2',     'extraHumid2',       null,        null,     false,   false,    1,      false,    true,     'extrahumid2',      '{}'),
(50, 'leaftemp1',       'leaf_temp1',       'leafTemp1',         null,        null,     false,   false,    1,      false,    true,     'leaftemp1',        '{}'),
(51, 'leaftemp2',       'leaf_temp2',       'leafTemp2',         null,        null,     false,   false,    1,      false,    true,     'leaftemp2',        '{}'),
(54, 'leafwet1',        'leaf_wet1',        'leafWet1',          null,        null,     false,   false,    1,      false,    true,      'leafwet1',        '{}'),
(55, 'leafwet2',        'leaf_wet2',        'leafWet2',          null,        null,     false,   false,    1,      false,    true,      'leafwet2',        '{}'),
(60, 'radiation',       'radiation',        'radiation',       'skip',        null,     false,   false,    2,      false,    true,            null,
  '{"w_dump": "lambda x: x * 0.03"}'),
(61, 'radiation_rate', 'radiation_rate',    'radiation',         null,        null,     false,   false,    3,      false,    true,            null,        '{}'),
(62, 'uv_indice',       'uv',               'UV',                null,        null,     false,   false,    3,      false,    true,            null,        '{}'),
(70, 'rain',            'rain',             'rain',            'skip',        null,     false,   false,    2,      false,    true,            null,
  '{"w_dump": "lambda x: x * 10"}'),
(71, 'rain_utc',        'rain_utc',         'rain_utc',        'skip',        null,     false,   false,    2,      false,    true,            null,        '{}'),
(72, 'rain rate',       'rain_rate',        'rainRate',          null,        null,     false,   false,    3,      false,    true,            null,        '{}'),
(80, 'rx',              'rx',               'rxCheckPercent',    null,        null,     false,   false,    4,      false,    true,            null,        '{}'),
(90, 'soilmoist1',      'soil_moist1',      'soilMoist1',        null,        null,     false,   false,    1,      false,    true,    'soilmoist1',        '{}'),
(91, 'soilmoist2',      'soil_moist2',      'soilMoist2',        null,        null,     false,   false,    1,      false,    true,    'soilmoist2',        '{}'),
(92, 'soilmoist3',      'soil_moist3',      'soilMoist3',        null,        null,     false,   false,    1,      false,    true,    'soilmoist3',        '{}'),
(93, 'soilmoist4',      'soil_moist4',      'soilMoist4',        null,        null,     false,   false,    1,      false,    true,    'soilmoist4',        '{}'),
(94, 'soiltemp1',       'soil_temp1',       'soilTemp1',         null,        null,     false,   false,    4,      false,    true,     'soiltemp1',        '{}'),
(95, 'soiltemp2',       'soil_temp2',       'soilTemp2',         null,        null,     false,   false,    4,      false,    true,     'soiltemt2',        '{}'),
(96, 'soiltemp3',       'soil_temp3',       'soilTemp3',         null,        null,     false,   false,    4,      false,    true,     'soiltemp3',        '{}'),
(97, 'soiltemp4',       'soil_temp4',       'soilTemp4',         null,        null,     false,   false,    4,      false,    true,     'soiltemp4',        '{}'),
(100, 'voltage',         'voltage',         'consBatteryVoltage',null,        null,     false,   false,    3,      false,    true,            null,        '{}'),
(110, 'wind dir',        'wind_dir',        'windDir',          'skip',       null,     false,   false,    0,      false,    true,            null,        '{}'),
(111, 'wind',            'wind',            'windSpeed',        'wind',       110,      false,   true,     1,      false,    true,            null,
  '{"mfr_csv": "lambda x: x * 3.6"}'),
(113, 'gust dir',        'wind_gust_dir',   'windGustDir',      'skip',       null,     false,   false,    0,      false,    true,  'wind_max_dir',        '{}'),
(114, 'gust',            'wind_gust',       'windGust',         'wind',       113,      false,   true,     3,       true,    true,      'wind_max',
  '{"mfr_csv": "lambda x: x * 3.6"}'),
(115, 'windchill',       'windchill',       'windchill',         null,        null,     false,   false,    4,      false,    true,            null,        '{}')
;

insert into annotations
(id,time,timeend,text,tags) values
(1,'2022-02-01 00:00:00','2022-02-05 00:00:00','Batsirai','système, cyclone intense'),
(2,'2022-02-19 00:00:00','2022-02-23 00:00:00','Emnati','système, cyclone intense'),
(3,'2018-01-16 12:00:00','2018-01-19 04:00:00','Berguitta','système,cyclone tropical intense'),
(4,'2021-01-11 00:00:00','2021-01-13 12:00:00','Danilo','forte tempête tropicale, système'),
(5,'2021-03-06 00:00:00','2021-03-08 00:00:00','Iman','système,tempête tropicale modérée'),
(6,'2019-12-29 00:00:00','2019-12-31 12:00:00','Calvinia','système, cyclone tropical'),
(7,'2018-03-03 12:00:00','2018-03-06 18:00:00','Dumazile','système, cyclone tropical intense'),
(8,'2019-11-24 00:00:00','2019-11-24 00:00:00','TAR600','première donnée'),
(9,'2011-04-13 00:00:00','2011-04-13 00:00:00','SBBM100','première donnée'),
(10,'2020-09-14 00:00:00','2020-09-14 00:00:00','CHP690','première donnée'),
(11,'2019-09-22 00:00:00','2019-09-22 00:00:00','PFD040','première donnée'),
(12,'2020-01-10 00:00:00','2020-01-10 00:00:00','NDLP1520','première donnée'),
(13,'2020-11-25 00:00:00','2020-11-25 00:00:00','BOCO1370','première donnée'),
(14,'2022-08-23 00:00:00','2022-08-23 00:00:00','BPN100','première donnée'),
(15,'2017-06-10 00:00:00','2017-06-10 00:00:00','BAG280','première donnée'),
(16,'2018-06-30 00:00:00','2018-06-30 00:00:00','ESB005','première donnée'),
(17,'2021-12-10 00:00:00','2021-12-10 00:00:00','TAM1790','première donnée'),
(18,'2013-03-24 00:00:00','2013-03-24 00:00:00','ESH555','première donnée'),
(19,'2020-08-26 00:00:00','2020-08-26 00:00:00','CHAR645','première donnée'),
(20,'2018-02-25 00:00:00','2018-02-25 00:00:00','TRM490','première donnée'),
(21,'2015-06-24 00:00:00','2015-06-24 00:00:00','BBF015','première donnée'),
(22,'2015-06-27 00:00:00','2015-06-27 00:00:00','RAM450','première donnée'),
(23,'2021-09-26 00:00:00','2021-09-26 00:00:00','LCV050','première donnée'),
(24,'2021-05-02 00:00:00','2021-05-02 00:00:00','BER590','première donnée'),
(25,'2019-11-24 00:00:00','2019-11-24 00:00:00','TAN1270','première donnée'),
(26,'2020-12-17 00:00:00','2020-12-17 00:00:00','FAY040','première donnée'),
(27,'2021-09-20 00:00:00','2021-09-20 00:00:00','MVP860','première donnée'),
(28,'2019-09-26 00:00:00','2019-09-26 00:00:00','BP130','première donnée'),
(29,'2019-02-05 00:00:00','2019-02-05 00:00:00','ELH675','première donnée'),
(30,'2019-08-09 00:00:00','2019-08-09 00:00:00','MTG320','première donnée'),
(31,'2020-08-11 00:00:00','2020-08-11 00:00:00','BOMU1610','première donnée'),
(32,'2017-03-04 00:00:00','2017-03-04 00:00:00','TBL105','première donnée'),
(33,'2017-03-09 00:00:00','2017-03-09 00:00:00','GDC030','première donnée'),
(34,'2023-12-11 00:00:00','2023-12-11 00:00:00','MTG280','première donnée'),
(35,'2022-02-10 00:00:00','2022-02-10 00:00:00','MAT315','première donnée'),
(36,'2019-09-26 00:00:00','2019-09-26 00:00:00','PSL310','première donnée'),
(37,'2017-12-11 00:00:00','2017-12-11 00:00:00','SPC010','première donnée'),
(38,'2014-12-31 00:00:00','2014-12-31 00:00:00','BRT240','première donnée'),
(39,'2016-10-20 00:00:00','2016-10-20 00:00:00','TRG170','première donnée'),
(40,'2021-04-22 00:00:00','2021-04-22 00:00:00','ROQ070','première donnée'),
(41,'2021-01-22 00:00:00','2021-01-22 00:00:00','CAM015','première donnée'),
(42,'2019-06-05 00:00:00','2019-06-05 00:00:00','LAN030','première donnée'),
(43,'2019-11-16 00:00:00','2019-11-16 00:00:00','PAH575','première donnée'),
(44,'2024-01-12 00:00:00','2024-01-17 00:00:00','Belal','système')
;
-- reset id serial to max id
SELECT SETVAL('annotations_id_seq', (SELECT MAX(id) FROM annotations));

-- display number of inserted rows
select 'nb postes: ' || count(*) from postes;
select 'nb mesures: ' || count(*) from mesures;
select 'nb annotations: ' || count(*) from annotations;

/****************
*  PROCEDURES
****************/
-- regenerer la table last_obs
CREATE OR REPLACE PROCEDURE refesh_last_obs()
LANGUAGE SQL
AS $BODY$
  delete from last_obs;
  insert into last_obs(poste_id, mesure_id, date_local, value)
    select poste_id, mesure_id, max(date_local) as date_local, last(value, date_local) as value  from obs group by 1,2;
$BODY$;

-- regenerer la table last_obs_date
CREATE OR REPLACE PROCEDURE refesh_last_obs_date()
LANGUAGE SQL
AS $BODY$
with max_dt as (select poste_id as pid, max(date_local) as ldt from obs group by 1) update postes set last_obs_date = (select ldt from max_dt where pid=id);
$BODY$;

-- ---------
-- Triggers
-- ---------
/*
*  maintain last_obs_date/id in poste table
*  update last_obs table
*/ 
CREATE OR REPLACE FUNCTION create_obs_trigger_fn()
  RETURNS TRIGGER LANGUAGE PLPGSQL AS
$BODY$
DECLARE
    obs_dat timestamp;
    last_obs_dat timestamp;
BEGIN
  select last_obs_date  into obs_dat from postes where id = NEW.poste_id;
  if obs_dat is null or new.date_local > obs_dat then
    update postes set last_obs_date = NEW.date_local, last_obs_id = NEW.id where id = NEW.poste_id;
  end if;

  -- Update last_obs
  select date_local from last_obs where poste_id = NEW.poste_id and mesure_id = NEW.mesure_id into obs_dat;

  if obs_dat is null then
    insert into last_obs (poste_id, mesure_id, date_local, value) values (NEW.poste_id, NEW.mesure_id, NEW.date_local, NEW.value);
  elsif obs_dat < NEW.date_local then
    update last_obs set date_local = NEW.date_local, value = NEW.value where poste_id = NEW.poste_id and mesure_id = NEW.mesure_id;
  end if;

  return NEW;
END
$BODY$;

CREATE OR REPLACE TRIGGER create_obs_trigger
  AFTER INSERT ON obs
  FOR EACH ROW EXECUTE PROCEDURE create_obs_trigger_fn();

/*
*  maintain last_obs_date/id in poste table
*  cascade qa_value to x_min/x_max tables
*  update last_obs table
*/ 
CREATE OR REPLACE FUNCTION update_obs_trigger_fn()
  RETURNS TRIGGER LANGUAGE PLPGSQL AS
$BODY$
DECLARE
BEGIN
  if NEW.qa_value <> OLD.qa_value then
    update x_min set qa_min = NEW.qa_value where obs_id = NEW.id;
    update x_max set qa_max = NEW.qa_value where obs_id = NEW.id;
  end if;
  return NEW;
END
$BODY$;

CREATE OR REPLACE TRIGGER update_obs_trigger
  AFTER UPDATE ON obs
  FOR EACH ROW EXECUTE PROCEDURE update_obs_trigger_fn();

/*
*  cascade delete obs to x_min/x_max
*/ 
CREATE OR REPLACE FUNCTION delete_obs_trigger_fn()
  RETURNS TRIGGER LANGUAGE PLPGSQL AS
$BODY$
DECLARE
BEGIN
    delete from x_min where obs_id = OLD.id;
    delete from x_max where obs_id = OLD.id;
  return OLD;
END
$BODY$;

CREATE OR REPLACE TRIGGER delete_obs_trigger
  AFTER UPDATE OR DELETE ON x_max
  FOR EACH ROW EXECUTE PROCEDURE delete_obs_trigger_fn();

/********************
* Init TimeScaleDB
********************/
  CREATE EXTENSION IF NOT EXISTS timescaledb;
  ALTER TABLE obs DROP CONSTRAINT obs_pkey;
  SELECT create_hypertable('obs',  by_range('date_local',  INTERVAL '100 days'), migrate_data => true);
  SELECT set_chunk_time_interval('obs', INTERVAL '100 days');
  DROP index if exists obs_poste_id_7ed1db30;
  DROP index if exists obs_mesure_id_2198080c;

  ALTER TABLE x_min DROP CONSTRAINT x_min_pkey;
  SELECT create_hypertable('x_min', by_range('date_local',  INTERVAL '200 days'), migrate_data => true);
  SELECT set_chunk_time_interval('x_min',  INTERVAL '200 days');
  DROP index if exists x_min_mesure_id_915a2d2e;
  DROP index if exists x_min_poste_id_a7ee3864;

  ALTER TABLE x_max DROP CONSTRAINT x_max_pkey;
  SELECT create_hypertable('x_max',  by_range('date_local',  INTERVAL '200 days'), migrate_data => true);
  SELECT set_chunk_time_interval('x_max',  INTERVAL '200 days');
  DROP index if exists x_max_mesure_id_a633699c;
  DROP index if exists x_max_poste_id_529ea905;

/*
* obs_hour
*/
create materialized view obs_hour WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 hour', o.date_local, origin => '1950-01-01') as date_local,
        o.poste_id as poste_id,
        o.mesure_id as mesure_id,
        m.agreg_type as agreg_type,
        sum(o.duration) as duration,
        CASE
          WHEN m.agreg_type = 1 THEN avg(o.value)
          WHEN m.agreg_type = 2 THEN sum(o.value)
          WHEN m.agreg_type = 3 THEN max(o.value)
          WHEN m.agreg_type = 4 THEN min(o.value)
           END AS value
  from obs o join mesures m on m.id = mesure_id
  where qa_value != 9 and duration <= 60 and m.agreg_type != 0
  group by 1,2,3,4
  order by 1,2,3
;

ALTER MATERIALIZED VIEW obs_hour set (timescaledb.materialized_only = false);

SELECT add_continuous_aggregate_policy('obs_hour',
  start_offset => INTERVAL '60 minute',
  end_offset => NULL,
  schedule_interval => INTERVAL '30 minutes');

/*
* obs_day
*/
create materialized view obs_day WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 day', o.date_local, origin => '1950-01-01') as date_local,
        o.poste_id as poste_id,
        o.mesure_id as mesure_id,
        m.agreg_type as agreg_type,
        sum(o.duration) as duration,
        CASE
          WHEN m.agreg_type = 1 THEN avg(o.value)
          WHEN m.agreg_type = 2 THEN sum(o.value)
          WHEN m.agreg_type = 3 THEN max(o.value)
          WHEN m.agreg_type = 4 THEN min(o.value)
           END AS value
  from obs o join mesures m on m.id = mesure_id
  where qa_value != 9 and m.agreg_type != 0
  group by 1,2,3,4
  order by 1,2,3
;

ALTER MATERIALIZED VIEW obs_day set (timescaledb.materialized_only = false);

SELECT add_continuous_aggregate_policy('obs_day',
  start_offset => INTERVAL '60 minute',
  end_offset => NULL,
  schedule_interval => INTERVAL '30 minutes');

/*
* obs_month
*/
create materialized view obs_month WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 month', o.date_local, origin => '1950-01-01') as date_local,
        o.poste_id,
        o.mesure_id,
        o.agreg_type,
        sum(o.duration) as duration,
        CASE
          WHEN o.agreg_type = 1 THEN avg(o.value)
          WHEN o.agreg_type = 2 THEN sum(o.value)
          WHEN o.agreg_type = 3 THEN max(o.value)
          WHEN o.agreg_type = 4 THEN min(o.value)
           END AS value
  from obs_day o join mesures m on m.id = mesure_id
  group by 1,2,3,4
  order by 1,2,3
;

ALTER MATERIALIZED VIEW obs_month set (timescaledb.materialized_only = false);

SELECT add_continuous_aggregate_policy('obs_month',
  start_offset => INTERVAL '2 days',
  end_offset => NULL,
  schedule_interval => INTERVAL '1 day');

/*
* x_min_day
*/
create materialized view x_min_day WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 day', x.date_local, origin => '1950-01-01') as date_local,
        x.poste_id as poste_id,
        x.mesure_id as mesure_id,
        m.agreg_type as agreg_type,
        CASE
          WHEN m.agreg_type = 2 THEN sum(x.min)  -- on utilise la somme quotidienne pour les mesures sommables
          ELSE min(x.min)
        END AS min,
        first(x.min_time, x.min) as min_time
  from x_min x join mesures m on m.id = x.mesure_id
  where x.qa_min != 9 and m.agreg_type != 3 and m.agreg_type != 0 and m.min is true
  group by 1,2,3,4
  order by 1,2,3
;

ALTER MATERIALIZED VIEW x_min_day set (timescaledb.materialized_only = false);

SELECT add_continuous_aggregate_policy('x_min_day',
  start_offset => INTERVAL '12 hours',
  end_offset => NULL,
  schedule_interval => INTERVAL '6 hours');

/*
* x_min_month
*/
create materialized view x_min_month WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 month', date_local, origin => '1950-01-01') as date_local,
        poste_id as poste_id,
        mesure_id as mesure_id,
        agreg_type as agreg_type,
        min(min) AS min,    -- on prend le min des min quotidiens
        first(min_time, min) as min_time
  from x_min_day
 group by 1,2,3,4
 order by 1,2,3
;

ALTER MATERIALIZED VIEW x_min_month set (timescaledb.materialized_only = false);

SELECT add_continuous_aggregate_policy('x_min_month',
  start_offset => INTERVAL '2 days',
  end_offset => NULL,
  schedule_interval => INTERVAL '1 day');

/*
* x_max_day
*/
create materialized view x_max_day WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 day', x.date_local, origin => '1950-01-01') as date_local,
        x.poste_id as poste_id,
        x.mesure_id as mesure_id,
        m.agreg_type as agreg_type,
        CASE
          WHEN m.agreg_type = 2 THEN sum(x.max)   -- on utilise la somme quotidienne pour les mesures sommables
          ELSE max(x.max)
        END AS max,
        last(x.max_time, x.max) as max_time,
        last(x.max_dir, x.max) as max_dir
  from x_max x join mesures m on m.id = mesure_id
  where qa_max != 9 and m.agreg_type != 4 and m.agreg_type != 0 and m.max is true
  group by 1,2,3,4
  order by 1,2,3
;

ALTER MATERIALIZED VIEW x_max_day set (timescaledb.materialized_only = false);

SELECT add_continuous_aggregate_policy('x_max_day',
  start_offset => INTERVAL '12 hours',
  end_offset => NULL,
  schedule_interval => INTERVAL '6 hours');

/*
* x_max_month
*/
create materialized view x_max_month WITH (timescaledb.continuous) as
  select
        timescaledb_experimental.time_bucket_ng('1 month', date_local, origin => '1950-01-01') as date_local,
        poste_id as poste_id,
        mesure_id as mesure_id,
        agreg_type as agreg_type,
        max(max) AS max,      -- on prend le max des max quotidiens
        last(max_time, max) as max_time,
        last(max_dir, max) as max_dir
  from x_max_day
  group by 1,2,3,4
  order by 1,2,3
;

ALTER MATERIALIZED VIEW x_max_month set (timescaledb.materialized_only = false);

SELECT add_continuous_aggregate_policy('x_max_month',
  start_offset => INTERVAL '2 days',
  end_offset => NULL,
  schedule_interval => INTERVAL '1 day');

-- refresh all materialized views
CREATE OR REPLACE PROCEDURE refresh_all_mv(start_date timestamp = null)
LANGUAGE plpgsql
AS $$
BEGIN
  CALL refresh_continuous_aggregate('obs_hour', start_date, null);
  CALL refresh_continuous_aggregate('obs_day', start_date, null);
  CALL refresh_continuous_aggregate('obs_month', start_date, null);
  CALL refresh_continuous_aggregate('x_min_day', start_date, null);
  CALL refresh_continuous_aggregate('x_min_month', start_date, null);
  CALL refresh_continuous_aggregate('x_max_day', start_date, null);
  CALL refresh_continuous_aggregate('x_max_month', start_date, null);
END; $$;

-- create materialized view compare_month WITH (timescaledb.continuous) as
-- materialized view does not support left join...

--  select
--         timescaledb_experimental.time_bucket_ng('1 month', o.date_local, origin => '1950-01-01') as date_local,
--         o.poste_id,
--         avg(o.value) as avg_value,
--         min(mi.min),
--         first(mi.min_time, mi.min) as min_time,
--         max(ma.max),
--         last(ma.max_time, ma.max) as max_time
--     from obs_month o 
--       left join x_min_month mi on 
--         o.poste_id = mi.poste_id
--         and o.mesure_id = mi.mesure_id
--         and timescaledb_experimental.time_bucket_ng('1 month', mi.date_local, origin => '1950-01-01') = timescaledb_experimental.time_bucket_ng('1 month', mi.date_local, origin => '1950-01-01')
--       left join x_max_month ma on 
--         o.poste_id = ma.poste_id
--         and o.mesure_id = ma.mesure_id
--         and timescaledb_experimental.time_bucket_ng('1 month', ma.date_local, origin => '1950-01-01') = timescaledb_experimental.time_bucket_ng('1 month', ma.date_local, origin => '1950-01-01')
--     where o.mesure_id = 1
-- --       Important to add a where on each table => 
-- --           timescale can limit the search in the underlying chunks for each table
--       and o.date_local > '202-12-01'
--       and mi.date_local > '202-12-01'
--       and ma.date_local > '202-12-01'
--     group by 1,2;

/*
Id_station;Id_omm;Nom_usuel;Latitude;Longitude;Altitude;Date_ouverture;Pack
97401520;;LE TEVELAVE;-21.211667;55.361333;908;1953-01-01;ETENDU
97401540;;LES AVIRONS - CIRAD;-21.239500;55.327500;180;1952-01-01;ETENDU
97402240;;BELLEVUE BRAS-PANON;-21.005000;55.622667;480;1990-09-01;RADOME
97403410;;LE DIMITILE_SAPC;-21.189000;55.481500;1808;2013-09-27;ETENDU
97403435;;BRAS-LONG_SAPC;-21.228333;55.474667;510;2013-05-22;ETENDU
97404540;;PONT-MATHURIN;-21.265000;55.380000;19;1961-06-01;RADOME
97405420;;PITON-BLOC_SAPC;-21.321167;55.572333;812;1990-01-01;ETENDU
97406220;;PLAINE DES PALMISTES;-21.136167;55.627167;1032;1952-01-01;RADOME
97407520;61981;LE PORT;-20.946167;55.282000;9;1971-04-18;RADOME
97408510;;POSSESSION;-20.921333;55.346167;9;1997-10-01;ETENDU
97408560;;AURERE_SAPC;-21.018833;55.424833;940;1952-01-01;ETENDU
97408580;;LA NOUVELLE_SAPC;-21.076667;55.423333;1415;1970-01-01;ETENDU
97408582;;DOS D'ANE;-20.978500;55.390500;1027;2022-05-02;ETENDU
97409210;;BOIS-ROUGE;-20.913667;55.641333;5;1952-01-01;ETENDU
97409230;;LE COLOSSE;-20.934500;55.664500;16;1957-03-01;RADOME
97409240;;MENCIOL;-20.961167;55.625667;181;1953-01-01;ETENDU
97410202;;BEAUVALLON;-21.008000;55.693333;16;1952-01-01;ETENDU
97410238;;SAINT-BENOIT;-21.058833;55.719333;43;1952-01-01;RADOME
97410250;;TAKAMAKA - PK12_SAPC;-21.076333;55.630833;660;1971-11-01;ETENDU
97410265;;CHEMIN DE CEINTURE_SAPC;-21.076333;55.685500;255;2003-07-24;ETENDU
97411132;;CHAUDRON;-20.897000;55.495000;38;1967-01-01;ETENDU
97411141;;GRANDE-CHALOUPE;-20.898333;55.369833;10;1997-10-01;ETENDU
97411146;;COLORADO_SAPC;-20.910500;55.421500;702;2003-02-26;ETENDU
97411150;;SAINT-FRANCOIS;-20.921333;55.456333;545;1953-03-01;ETENDU
97411155;;MONTAUBAN_SAPC;-20.938667;55.496833;420;2009-09-29;ETENDU
97411164;;LE BRULE - VAL FLEURI_SAPC;-20.941667;55.429500;1069;1956-09-01;ETENDU
97411170;;PLAINE DES CHICOTS_SAPC;-20.987333;55.444833;1834;1982-01-01;ETENDU
97412302;;COMMERSON_SAPC;-21.208000;55.643667;2310;1968-01-01;ETENDU
97412336;;GRAND-COUDE_SAPC;-21.301667;55.631333;1085;1978-01-01;ETENDU
97412340;;GRAND-GALET;-21.311000;55.639500;505;1953-08-06;ETENDU
97412356;;LA CRETE_SAPC;-21.337500;55.667667;659;1968-10-01;ETENDU
97412384;;ST-JOSEPH_SAPC;-21.385167;55.609667;13;1960-04-01;ETENDU
97412801;;ST JOSEPH-CIRAD;-21.385167;55.609667;13;2021-10-05;ETENDU
97413520;;COLIMACONS;-21.130333;55.304667;798;1963-08-01;RADOME
97413542;;ST-LEU;-21.190000;55.292333;79;1950-10-01;ETENDU
97413545;;SAINT-LEU - CIRAD;-21.187333;55.300833;222;1997-01-01;ETENDU
97413550;;ETANG SAINT-LEU - CIRAD;-21.173333;55.308833;429;2002-02-01;ETENDU
97413580;;PITON SAINT-LEU_SAPC;-21.215167;55.325833;530;1973-02-01;ETENDU
97414409;;PLAINE DES MAKES_SAPC;-21.199500;55.409167;980;2004-12-29;ETENDU
97414431;;LE GOL LES HAUTS - CIRAD;-21.245833;55.428000;365;1997-01-01;ETENDU
97414451;;LE TAPAGE - CIRAD;-21.224667;55.444167;863;2002-03-25;ETENDU
97415516;;BOIS DE NEFLES ST-PAUL_SAPC;-20.997500;55.341167;595;1952-01-01;ETENDU
97415536;;PETITE-FRANCE;-21.045000;55.342000;1200;1999-09-01;RADOME
97415541;;TAN-ROUGE_SAPC;-21.069167;55.299667;750;1960-01-01;ETENDU
97415550;;L'ERMITAGE - CIRAD;-21.053000;55.241333;147;2002-05-01;ETENDU
97415557;;LE GUILLAUME;-21.064667;55.324333;1035;1953-01-01;ETENDU
97415566;;PITON-MAIDO;-21.076667;55.381167;2150;1998-11-18;RADOME
97415590;;POINTE DES TROIS-BASSINS;-21.105167;55.247667;5;1987-10-02;RADOME
97415592;;TAN ROUGE-CIRAD;-21.069167;55.299667;746;2021-06-02;ETENDU
97416410;;RAVINE DES CABRIS - CIRAD;-21.274500;55.475333;310;1997-01-01;ETENDU
97416463;;PIERREFONDS-AEROPORT;-21.320000;55.425500;21;1999-01-01;RADOME
97416465;;LIGNE-PARADIS - CIRAD;-21.319167;55.485167;156;1966-01-01;ETENDU
97417340;;LE TREMBLET;-21.317333;55.801000;91;1953-01-01;ETENDU
97417360;;LE BARIL;-21.359000;55.732167;114;1989-02-01;RADOME
97418110;61980;GILLOT-AEROPORT;-20.892167;55.528667;8;1953-01-01;RADOME
97418123;;LA MARE - CIRAD;-20.903500;55.532000;68;2001-01-01;ETENDU
97418170;;PLAINE DES FOUGERES_SAPC;-20.967333;55.527833;1064;1993-06-01;ETENDU
97419310;;RIVIERE DE L'EST - CIRAD;-21.120167;55.758667;144;1953-01-01;ETENDU
97419320;;HAUTS DE SAINTE-ROSE_SAPC;-21.159500;55.763667;820;1973-07-01;ETENDU
97419350;;GROS PITON SAINTE-ROSE;-21.179500;55.828833;181;1987-09-01;RADOME
97419380;;BELLECOMBE-JACOB;-21.217833;55.687000;2245;1966-11-01;RADOME
97420110;;GRAND-HAZIER - CIRAD;-20.902833;55.586000;69;1953-01-01;ETENDU
97420150;;BAGATELLE_SAPC;-20.931000;55.576667;262;1953-01-01;ETENDU
97420180;;BRAS-PISTOLET_SAPC;-20.969000;55.587500;556;2002-12-01;ETENDU
97421210;;MARE A VIEILLE PLACE;-21.027833;55.512167;870;1989-07-01;ETENDU
97421220;;GRAND-ILET_SAPC;-21.028667;55.471667;1185;1973-07-01;ETENDU
97421240;;SALAZIE-VILLAGE_SAPC;-21.031667;55.538500;476;1996-01-01;ETENDU
97421260;;BELOUVE_SAPC;-21.060833;55.536500;1500;1955-09-01;ETENDU
97421265;;ILET A VIDOT_SAPC;-21.063167;55.510333;940;2003-12-01;ETENDU
97422440;;PLAINE DES CAFRES;-21.209167;55.572833;1560;1948-01-01;RADOME
97422445;;BRAS-SEC;-21.205667;55.525167;1210;1969-11-15;ETENDU
97422455;;PONT D'YVES;-21.231333;55.503167;835;1977-07-19;ETENDU
97422465;;LE TAMPON - CIRAD;-21.251667;55.530333;860;1958-01-01;ETENDU
97424410;;CILAOS;-21.134167;55.471667;1197;1952-01-01;RADOME
97424450;;ILET A CORDES_SAPC;-21.153500;55.438167;1067;1977-08-08;ETENDU
97424460;;PALMISTE-ROUGE;-21.168667;55.474500;830;1962-01-01;ETENDU
*/